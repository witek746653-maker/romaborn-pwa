<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>Распределение — мобильная</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffe9c4">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --ink:#2c2a29;--bg:#ffffff;--panel:#fffdfc;--line:#8b5e57;--muted:#7a6662;
    --accent:#f5e6da;--active:#ffe9c4;--badge:#ffd84d;
    --chip:#ffffff;
    --scale:0.92; /* компактней на мобилке */
  }
  [data-theme="dark"]{
    --bg:#121212;--panel:#1a1716;--ink:#ededed;--line:#6f554f;--muted:#b7a7a3;--accent:#2a231f;--active:#2b2623;--chip:#181616;--badge:#9b7a00;
  }
  [data-theme="daltonic"]{
    --accent:#eaeaea;--active:#e2f0ff;--badge:#c9e265;--line:#5b6b7a;
  }

  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.28 system-ui,-apple-system,Segoe UI,Roboto}
  button,input,select,textarea{font:inherit;color:inherit}
  .wrap{max-width:980px;margin:0 auto;padding:8px;transform:scale(var(--scale));transform-origin:top center}

  .box{border:2px solid var(--line);border-radius:6px;background:var(--panel)}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pad{padding:8px}
  .topbar{display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:8px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .ctrl{border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:6px 10px;cursor:pointer}
  .ctrl.primary{background:var(--accent)}
  .mini{font-size:12px;padding:4px 8px}
  .wday{min-width:160px}
  .grow{flex:1 1 auto}
  .badge{border:2px solid var(--line);background:var(--badge);color:#1f1a0f;border-radius:20px;padding:6px 12px;font-weight:700}

  .halls{display:flex;flex-wrap:wrap;gap:8px}
  .hall-btn{position:relative;border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:8px 10px;cursor:pointer}
  .hall-btn.active{background:var(--active)}
  .hall-count{position:absolute;right:-6px;top:-6px;background:var(--badge);border:2px solid var(--line);border-radius:12px;padding:2px 6px;font-size:11px;line-height:1;color:#1f1a0f}

  .pill{border:2px solid var(--line);background:var(--chip);border-radius:20px;padding:6px 10px;cursor:pointer}

  .main{display:grid;grid-template-columns:1fr 1.2fr;gap:10px}
  @media (max-width:760px){ .main{grid-template-columns:1fr} }
  .left{display:grid;gap:10px}

  .banquets{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
  .b-chip{border:2px solid var(--line);border-radius:10px;padding:4px 6px;display:inline-flex;align-items:flex-start;gap:6px;color:var(--ink);background:var(--chip);min-width:0}
  .b-chip .x{border:none;background:none;font-weight:900;font-size:16px;line-height:1;cursor:pointer;margin-left:2px}
  .b-ico{font-size:16px;line-height:1;margin-top:1px}
  .b-body{display:flex;flex-direction:column;gap:2px;min-width:0}
  .b-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
  .b-note{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}

  .waiters-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .waiters{border:2px solid var(--line);border-radius:6px;padding:8px;background:var(--chip)}
  .w-title{font-weight:800}
  .w-row{display:flex;flex-wrap:wrap;gap:6px}

  .wchip{border:2px solid var(--line);background:var(--chip);border-radius:8px;min-width:90px;padding:6px 6px 4px;display:inline-flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer}
  .wchip.active{outline:2px solid #0003}
  .w-main{display:flex;align-items:center;gap:6px}
  .w-dot{width:10px;height:10px;border-radius:50%}
  .w-name{font-weight:600}
  .w-tools{display:flex;gap:4px}
  .iconbtn{border:1px solid var(--line);background:var(--chip);border-radius:4px;padding:0 6px;line-height:18px;height:18px;cursor:pointer}
  .w-note{font-size:11px;color:var(--muted);max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .toggle{border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:6px 8px;cursor:pointer;width:100%;text-align:center;margin-top:6px}

  .count-pill{border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:3px 8px;font-size:12px}
  .right .head{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .zones{border:2px solid var(--line);border-radius:6px;background:var(--chip);min-height:320px;padding:8px}
  .zone{border:2px dashed var(--line);border-radius:6px;padding:8px;margin:8px 0}
  .zone .zhead{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .zone .slot{display:flex;flex-wrap:wrap;gap:6px}

  .assign{border:2px solid var(--line);border-radius:8px;padding:4px 6px;display:inline-flex;gap:4px;align-items:center;flex-direction:column;min-width:90px;background:var(--chip)}
  .assign .row1{display:flex;gap:6px;align-items:center}
  .assign .nm{font-weight:600}
  .assign .small{font-size:11px;color:var(--muted);max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .assign .x{border:none;background:none;font-weight:900;font-size:16px;line-height:1;cursor:pointer}

  .muted{color:var(--muted)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:10px;z-index:50}
  .dialog{background:var(--chip);border:2px solid var(--line);border-radius:8px;max-width:95vw;max-height:95vh;overflow:auto}
  .dialog .pad{padding:10px}

  /* схема */
  .plan-wrap{position:relative;max-width:92vw}
  .plan-img{width:100%;height:auto;display:block}
  .plan-tags{position:absolute;inset:0;pointer-events:auto}
  .tag{position:absolute;padding:6px 8px;border-radius:8px;font-size:14px;color:#111;background:rgba(255,255,0,.65);cursor:grab;touch-action:none;user-select:none}
  .tag:active{cursor:grabbing}

  /* темы банкетов */
  .bt-DR {background:#ffe8e8}
  .bt-Юбилей {background:#e8f7ff}
  .bt-День\ памяти {background:#f3f4f6}
  .bt-Корпоратив {background:#e8fff1}
  .bt-Конференция {background:#fff7e6}
  .bt-Свадьба {background:#fff0f6}
</style>
</head>
<body>
<div class="wrap" id="app">

  <!-- ВЕРХ -->
  <div class="topbar box pad">
    <div class="controls">
      <div class="ctrl">
        <div class="muted mini">Календарь</div>
        <input id="date" type="date"/>
      </div>

      <div class="ctrl wday" id="wday">День недели<br/>Число.Месяц.</div>

      <div id="shiftBadge" class="badge">В смене 0 человек</div>

      <button class="ctrl" id="sendBtn">Отправить</button>
      <button class="ctrl" id="sendPlanBtn">Отправить схему</button>
      <button class="ctrl" id="breakfastBtn">График работы на завтраках</button>
      <button class="ctrl" id="resetBtn">Сбросить все</button>

      <div class="grow"></div>

      <select id="themeSel" class="ctrl mini" title="Тема">
        <option value="light">Светлая</option>
        <option value="dark">Тёмная</option>
        <option value="daltonic">Дальтоник</option>
      </select>

      <button class="ctrl" id="refreshBtn">Обновить</button>
      <button class="ctrl" id="addTextBtn">Добавить текст</button>
      <button class="ctrl" id="saveBtn">Сохранить</button>
      <button class="ctrl" id="importBtn">Импорт</button>
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
      <button class="ctrl" id="statsBtn">Статистика</button>
    </div>

    <div class="controls">
      <div class="muted">Банкеты</div>
      <div id="banquetPanel" class="banquets"></div>
      <button class="ctrl primary mini" id="addBanquetBtn">Добавить</button>
    </div>
  </div>

  <!-- ЗАЛЫ -->
  <div class="box pad">
    <div class="muted mini" style="margin-bottom:6px">Залы</div>
    <div class="halls" id="hallBar"></div>
    <button id="layoutBtn" class="pill mini">Расстановка</button>
  </div>

  <!-- ОСНОВНОЙ МАКЕТ -->
  <div class="main">
    <div class="left">
      <div class="box pad">
        <div class="waiters-head">
          <div class="w-title">Официанты</div>
          <button class="ctrl mini" id="addWaiterBtn">Добавить</button>
        </div>
        <div class="waiters">
          <div class="muted mini">Смена 1</div>
          <div id="wRow1" class="w-row"></div>

          <button id="toggleShift2" class="toggle">Смена 2</button>
          <div id="wRow2Wrap" style="display:none;margin-top:6px">
            <div class="muted mini">Смена 2</div>
            <div id="wRow2" class="w-row"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="head">
        <div class="muted">Зоны</div>
        <div class="count-pill" id="zoneTitle">—</div>
        <button id="planBtn" class="ctrl mini" style="display:none">Схема</button>
        <div id="ozTools" style="display:none;gap:6px" class="row">
          <button class="ctrl mini" id="ozStd">Стандартные зоны</button>
          <button class="ctrl mini" id="ozCustom">Свои зоны</button>
          <button class="ctrl mini" id="ozReset">Сбросить зоны</button>
          <button class="ctrl mini" id="ozScheme">Зонирование по схеме (β)</button>
        </div>
      </div>
      <div class="zones" id="zonesBox"></div>
    </div>
  </div>
</div>

<!-- Модалка -->
<template id="modalTpl">
  <div class="modal"><div class="dialog"><div class="pad" id="modalBody"></div></div></div>
</template>

<script>
(function(){
'use strict';

/* ===== Константы/иконки ===== */
const STORAGE='rota-mobile-v6';
const MAX_AGE_DAYS=60;
const DEFAULT_HALLS={
  'Основной зал':['Весь зал','Зона окна','5-я линия','Столы 7,8,9','Столы 10,11,12','Подиум'],
  'Малый (банкетный) зал':['МБЗ'],
  'ВИП-комнаты':['Все ВИПы','Большой ВИП','Малый ВИП','Каюта','Лиенда'],
  'Лофт':['Лофт'],
  'Веранда':['Веранда 1','Веранда 2'],
  'Винная комната':['Винная комната']
};
const SH1=['Элона','Полина','Настя','Виктор','Натали Ч.','Рома','Ксюша'];
const SH2=['Юля','Игорь','Катя','Наташа В.','Наташа Вел.','Артем','Маша','Инна','Лёша'];

const HALL_ICONS={'Основной зал':'🏛️','Малый (банкетный) зал':'🎊','ВИП-комнаты':'👑','Лофт':'🧱','Веранда':'🌴','Винная комната':'🍷'};
const ZONE_ICONS={
  'Весь зал':'🏛️','Зона окна':'🪟','5-я линия':'📚','Столы 7,8,9':'🍽️','Столы 10,11,12':'🍽️','Подиум':'🪜',
  'МБЗ':'🎉','Все ВИПы':'👑','Большой ВИП':'🔥','Малый ВИП':'📚','Каюта':'🛞','Лиенда':'🌊','Веранда 1':'🚭','Веранда 2':'🚬','Лофт':'🧱','Винная комната':'🍷'
};

const BANQUET_META={
  'ДР':{ico:'🎂',cls:'bt-DR'}, 'Юбилей':{ico:'🎉',cls:'bt-Юбилей'}, 'День памяти':{ico:'🕯️',cls:'bt-День памяти'},
  'Корпоратив':{ico:'🏢',cls:'bt-Корпоратив'}, 'Конференция':{ico:'🎤',cls:'bt-Конференция'}, 'Свадьба':{ico:'💍',cls:'bt-Свадьба'},
};
const BANQUET_TYPES=Object.keys(BANQUET_META);

/* смайлики статусов (#17) */
const NOTE_EMOJI={
  'Помощь в ОЗ':'🪟','Помощь на ВИПах':'👑','Помощь в МБЗ':'🎉',
  'Помощь на Веранде 1':'🚭','Помощь на Веранде 2':'🚬',
  'Доставка':'🚚','1-ый номер':'1️⃣','2-ой номер':'2️⃣',
  'Посуда на цеха':'🍽️','Заполнить водопады':'💧','Минаж':'🍽️','Триджеки':'🍴','Куллера':'💧','Камины':'🔥','Завтрак':'☕'
};
const NOTE_PRESETS=[
  'Помощь в ОЗ','Помощь на ВИПах','Помощь в МБЗ','Помощь на Веранде 1','Помощь на Веранде 2',
  'Доставка','1-ый номер','2-ой номер','Посуда на цеха','Заполнить водопады','Минаж','Триджеки','Куллера','Камины'
];

const $=s=>document.querySelector(s), modalTpl=$('#modalTpl');

/* ===== Утилиты ===== */
function todayISO(){ const z=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-z).toISOString().slice(0,10); }
function weekday(iso){ const d=new Date(iso+'T00:00'); return ['воскресенье','понедельник','вторник','среда','четверг','пятница','суббота'][d.getDay()]; }
function fmtDate(iso){ const [y,m,d]=iso.split('-'); return `${d}.${m}.${y}`; }
function modal(){ const host=modalTpl.content.firstElementChild.cloneNode(true); const body=host.querySelector('#modalBody'); function close(){ host.remove(); } host.addEventListener('click',e=>{ if(e.target===host) close(); }); document.body.appendChild(host); return {el:host,body,close}; }
function colorFor(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; const hue=h%360, sat=65, light=70; const fg=(light>60)?'#1f2937':'#fff'; return {bg:`hsl(${hue} ${sat}% ${light}%)`, fg}; }

/* ===== База ===== */
function defaultDB(){ return {waiters:{shift1:[...SH1],shift2:[...SH2]}, halls:JSON.parse(JSON.stringify(DEFAULT_HALLS)), data:{}, breakfasts:{}, ui:{theme:'light'}}; }
let db=load()||defaultDB();
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE));}catch{return null} }
function save(){ localStorage.setItem(STORAGE, JSON.stringify(db)); }
function purgeOld(){
  const now=new Date(todayISO()+'T00:00'); const day=86400000;
  for(const k of Object.keys(db.data)){ const d=new Date(k+'T00:00'); if((now-d)/day>MAX_AGE_DAYS) delete db.data[k]; }
  for(const k of Object.keys(db.breakfasts)){ const d=new Date(k+'T00:00'); if((now-d)/day>MAX_AGE_DAYS) delete db.breakfasts[k]; }
}
purgeOld(); save();

/* ===== День ===== */
function curDay(){ return $('#date').value||todayISO(); }
function dayData(){
  const k=curDay();
  const init={assign:{},banquets:[],extraText:'',wNotes:{},ozCustom:null,ozScheme:[]};
  db.data[k] ||= init;
  // миграция wNotes: строка -> массив
  const d=db.data[k]; for(const n of Object.keys(d.wNotes)){ if(typeof d.wNotes[n]==='string') d.wNotes[n]=d.wNotes[n]?[d.wNotes[n]]:[]; }
  return d;
}

/* ===== Верх ===== */
function renderTop(){ const iso=curDay(); $('#wday').innerHTML=`${weekday(iso)}<br>${fmtDate(iso)}.`; }

/* ===== Залы/зоны ===== */
let currentHall='Основной зал';
function hallCountsFor(dateISO){
  const d=db.data[dateISO]; if(!d) return {};
  const perHall={};
  Object.keys(d.assign).forEach(h=>{
    const used=new Set();
    Object.values(d.assign[h]).forEach(arr=>arr.filter(x=>x.t==='w').forEach(x=>used.add(x.name)));
    perHall[h]=used.size;
  });
  return perHall;
}

function renderHalls(){
  const bar=$('#hallBar'); bar.innerHTML='';
  const counts=hallCountsFor(curDay());
  Object.keys(db.halls).forEach(h=>{
    const b=document.createElement('button');
    b.className='hall-btn'; b.textContent=h; if(h===currentHall) b.classList.add('active');
    if(counts[h]){ const c=document.createElement('span'); c.className='hall-count'; c.textContent=counts[h]; b.appendChild(c); }
    b.onclick=()=>{ currentHall=h; renderHalls(); renderZones(); };
    bar.appendChild(b);
  });
}
function ensureHallZone(h,z){ const d=dayData(); d.assign[h] ||= {}; d.assign[h][z] ||= []; return d.assign[h][z]; }

function banquetTitle(b){
  const meta=BANQUET_META[b.type]||{ico:'🎈',cls:''};
  const place = b.place ? (b.place.zone ? `${b.place.hall} — ${b.place.zone}` : b.place.hall) : '—';
  return `${meta.ico} ${b.type} • ${b.people} чел • ${place}${b.note?` • ${b.note}`:''}`;
}

function renderBanquetChip(b, small=false, onDelete=null, onEdit=null){
  const meta=BANQUET_META[b.type]||{ico:'🎈',cls:''};
  const s=document.createElement('span'); s.className=`b-chip ${meta.cls}`;
  s.innerHTML = `<span class="b-ico">${meta.ico}</span>
                 <span class="b-body">
                   <span class="b-title">${small?`${b.type} • ${b.people} • ${b.place?.zone||b.place?.hall||'—'}`:banquetTitle(b)}</span>
                   ${(b.note?`<span class="b-note">${b.note}</span>`:'')}
                 </span>`;
  if(onEdit){ s.style.cursor='pointer'; s.onclick=onEdit; }
  const x=document.createElement('button'); x.className='x'; x.title='Удалить'; x.textContent='×';
  x.onclick=(ev)=>{ ev.stopPropagation(); onDelete && onDelete(); };
  s.appendChild(x);
  return s;
}

function renderZones(){
  const d=dayData();
  $('#zoneTitle').textContent=currentHall;
  $('#planBtn').style.display=(currentHall==='Основной зал')?'inline-block':'none';
  $('#ozTools').style.display=(currentHall==='Основной зал')?'flex':'none';

  const box=$('#zonesBox'); box.innerHTML='';
  (db.halls[currentHall]||[]).forEach(z=>{
    const wrap=document.createElement('div'); wrap.className='zone';
    const head=document.createElement('div'); head.className='zhead';
    head.innerHTML=`<strong>${(ZONE_ICONS[z]||'•')} ${z}</strong>`;
    wrap.appendChild(head);
    const slot=document.createElement('div'); slot.className='slot'; wrap.appendChild(slot);

    const draw=()=>{
      slot.innerHTML='';
      const arr=ensureHallZone(currentHall,z);
      arr.forEach((e,i)=>{
        if(e.t==='w'){
          const item=document.createElement('div'); item.className='assign';
          const {bg,fg}=colorFor(e.name);
          item.style.background=bg; item.style.color=fg;
          const row=document.createElement('div'); row.className='row1';
          row.innerHTML=`<span class="nm">${e.name}</span> <button class="x" title="Удалить">×</button>`;
          const notes=(d.wNotes[e.name]||[]);
          const textNotes = notes.map(n=> (NOTE_EMOJI[n]?NOTE_EMOJI[n]+' ':'') + n).join('; ');
          const under=document.createElement('div'); under.className='small'; under.textContent=textNotes;
          item.appendChild(row); if(textNotes) item.appendChild(under);
          row.querySelector('.x').onclick=()=>{ arr.splice(i,1); save(); draw(); updateShiftBadge(); renderHalls(); };
          slot.appendChild(item);
        }else{
          const bb = d.banquets.find(x=>x.id===e.id); if(!bb) return;
          const chip = renderBanquetChip(bb,true,
            ()=>{ arr.splice(i,1); save(); draw(); renderBanquets(); },
            ()=> editBanquetModal(bb)
          );
          slot.appendChild(chip);
        }
      });
    };
    draw();

    wrap.addEventListener('click',()=>{
      if(!selected) return;
      const arr=ensureHallZone(currentHall,z);
      if(selected.kind==='w'){
        if(!arr.some(x=>x.t==='w'&&x.name===selected.name)){ arr.push({t:'w',name:selected.name}); }
      }else if(selected.kind==='b'){
        if(!arr.some(x=>x.t==='b'&&x.id===selected.id)){
          arr.push({t:'b',id:selected.id});
          const b=d.banquets.find(x=>x.id===selected.id); if(b){ b.place={hall:currentHall,zone:z}; }
        }
      }
      save(); draw(); updateShiftBadge(); renderHalls();
    });

    box.appendChild(wrap);
  });
}

/* схема с перетаскиванием */
$('#planBtn').addEventListener('click',()=>{ const host=modal(); const d=dayData();
  const tagsHTML = (d.ozScheme||[]).map((z,i)=>`<div class="tag" data-i="${i}" style="left:${z.x}%;top:${z.y}%;background:${z.color}AA">${z.label}</div>`).join('');
  host.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">Схема: Основной зал (перетаскивай метки)</div>
    <div class="plan-wrap" id="planWrap">
      <img src="oz-scheme.png" alt="Схема" class="plan-img" id="planImg"/>
      <div class="plan-tags" id="planTags">${tagsHTML}</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="ctrl mini" id="openSchemeZone">Добавить зону (β)</button>
      <a class="ctrl mini" href="oz-scheme.png" target="_blank" rel="noopener">Открыть</a>
      <button class="ctrl mini" id="c">Закрыть</button>
    </div>`;
  host.body.querySelector('#c').onclick=host.close;
  host.body.querySelector('#openSchemeZone').onclick=()=>{ host.close(); ozSchemeModal(); };

  const wrap=host.body.querySelector('#planWrap');
  const tags=host.body.querySelectorAll('.tag');

  let dragging=null, start={x:0,y:0}, rect=null;
  function setPos(el, px, py){
    let x=Math.max(0, Math.min(100, px)), y=Math.max(0, Math.min(100, py));
    const idx=+el.dataset.i;
    d.ozScheme[idx].x=x; d.ozScheme[idx].y=y;
    el.style.left=x+'%'; el.style.top=y+'%';
    save();
  }
  function onDown(e){
    dragging=e.target.closest('.tag'); if(!dragging) return;
    rect=wrap.getBoundingClientRect();
    if(e.touches){ start.x=e.touches[0].clientX; start.y=e.touches[0].clientY; }
    else { start.x=e.clientX; start.y=e.clientY; }
    e.preventDefault();
    window.addEventListener('mousemove',onMove,{passive:false});
    window.addEventListener('touchmove',onMove,{passive:false});
    window.addEventListener('mouseup',onUp,{once:true});
    window.addEventListener('touchend',onUp,{once:true});
  }
  function onMove(e){
    if(!dragging) return;
    let cx, cy;
    if(e.touches){ cx=e.touches[0].clientX; cy=e.touches[0].clientY; }
    else { cx=e.clientX; cy=e.clientY; }
    const relX = (cx-rect.left)/rect.width*100;
    const relY = (cy-rect.top)/rect.height*100;
    setPos(dragging, relX, relY);
    e.preventDefault();
  }
  function onUp(){ dragging=null; }
  wrap.addEventListener('mousedown',onDown);
  wrap.addEventListener('touchstart',onDown,{passive:false});
});

/* Свои зоны/стандарт/сброс */
$('#ozStd').onclick=()=>{ const d=dayData(); d.ozCustom=null; db.halls['Основной зал']=DEFAULT_HALLS['Основной зал'].slice(); save(); renderZones(); };
$('#ozCustom').onclick=()=>{ const d=dayData(); openCustomZonesModal(d); };
$('#ozReset').onclick=()=>{ if(!confirm('Удалить все созданные зоны и очистить назначения Основного зала?')) return;
  const d=dayData(); d.ozCustom=null; d.ozScheme=[]; d.assign['Основной зал']={}; db.halls['Основной зал']=DEFAULT_HALLS['Основной зал'].slice();
  save(); renderZones();
};
$('#ozScheme').onclick=()=>ozSchemeModal();

function openCustomZonesModal(d){
  const host=modal();
  const cur = d.ozCustom || DEFAULT_HALLS['Основной зал'].slice();
  host.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">Свои зоны (по одной на строке)</div>
    <textarea id="zonesTxt" class="ctrl" rows="6" style="width:100%">${cur.join('\n')}</textarea>
    <div class="row" style="justify-content:flex-end;margin-top:6px">
      <button class="ctrl primary mini" id="ok">Сохранить</button>
      <button class="ctrl mini" id="cl">Отмена</button>
    </div>`;
  host.body.querySelector('#ok').onclick=()=>{
    const lines = host.body.querySelector('#zonesTxt').value.split('\n').map(s=>s.trim()).filter(Boolean);
    d.ozCustom = lines;
    db.halls['Основной зал'] = lines.length? lines : DEFAULT_HALLS['Основной зал'].slice();
    save(); renderZones(); host.close();
  };
  host.body.querySelector('#cl').onclick=host.close;
}

/* Зонирование по схеме (создание меток) */
function ozSchemeModal(){
  const host=modal(); const d=dayData();
  host.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">Создать зону по столам (1–14)</div>
    <div class="row" style="gap:6px">
      <div><div class="muted mini">Название</div><input id="zName" class="ctrl" placeholder="Например: Столы 1-3"/></div>
      <div><div class="muted mini">Столы</div><input id="zTables" class="ctrl" placeholder="1,2,3"/></div>
      <div><div class="muted mini">Цвет</div><input id="zColor" class="ctrl" type="color" value="#ffd84d"/></div>
    </div>
    <div class="muted mini" style="margin-top:6px">Позиция метки (0–100%)</div>
    <div class="row" style="gap:6px">
      <div><div class="muted mini">Слева %</div><input id="zX" class="ctrl" type="number" min="0" max="100" value="50"/></div>
      <div><div class="muted mini">Сверху %</div><input id="zY" class="ctrl" type="number" min="0" max="100" value="50"/></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="ctrl primary mini" id="add">Добавить зону</button>
      <button class="ctrl mini" id="cl">Закрыть</button>
    </div>
    <div class="muted" style="margin-top:8px">Добавленные: ${(d.ozScheme||[]).map(z=>z.label).join(', ')||'—'}</div>`;
  host.body.querySelector('#add').onclick=()=>{
    const name=host.body.querySelector('#zName').value.trim();
    const tables=host.body.querySelector('#zTables').value.trim();
    const color=host.body.querySelector('#zColor').value;
    const x=+host.body.querySelector('#zX').value; const y=+host.body.querySelector('#zY').value;
    if(!name||!tables) return alert('Название и столы обязательны');
    d.ozScheme=d.ozScheme||[]; d.ozScheme.push({label:`${name} (${tables})`, color, x, y});
    if(!db.halls['Основной зал'].includes(name)) db.halls['Основной зал'].push(name);
    save(); host.close(); renderZones(); $('#planBtn').click();
  };
  host.body.querySelector('#cl').onclick=host.close;
}

/* ===== Официанты ===== */
let selected=null;

function waiterChip(name){
  const notes=dayData().wNotes[name]||[]; const {bg,fg}=colorFor(name);
  const chip=document.createElement('div'); chip.className='wchip'; if(selected&&selected.kind==='w'&&selected.name===name) chip.classList.add('active');

  const main=document.createElement('div'); main.className='w-main';
  const dot=document.createElement('div'); dot.className='w-dot'; dot.style.background=bg;
  const nm=document.createElement('div'); nm.className='w-name'; nm.textContent=name; nm.style.color=fg;
  const tools=document.createElement('div'); tools.className='w-tools';
  const edit=document.createElement('button'); edit.className='iconbtn'; edit.title='Комментарий'; edit.textContent='✎';
  const del=document.createElement('button'); del.className='iconbtn'; del.title='Удалить имя'; del.textContent='×';
  tools.append(edit,del); main.append(dot,nm,tools);
  const sub=document.createElement('div'); sub.className='w-note';
  sub.textContent = notes.map(n=> (NOTE_EMOJI[n]?NOTE_EMOJI[n]+' ':'')+n).join('; ');
  chip.append(main, sub);

  chip.addEventListener('click',(e)=>{ if(e.target===edit||e.target===del) return; selected=(selected&&selected.kind==='w'&&selected.name===name)?null:{kind:'w',name}; highlightWaiters(); });

  edit.addEventListener('click',(e)=>{ e.stopPropagation(); editNoteModal(name); });
  del.addEventListener('click',(e)=>{
    e.stopPropagation();
    if(!confirm(`Удалить "${name}" и убрать из зон?`)) return;
    db.waiters.shift1 = db.waiters.shift1.filter(n=>n!==name);
    db.waiters.shift2 = db.waiters.shift2.filter(n=>n!==name);
    const d=dayData();
    Object.values(d.assign).forEach(zmap=>{
      Object.keys(zmap).forEach(z=>{ zmap[z]=zmap[z].filter(e=>!(e.t==='w'&&e.name===name)); });
    });
    delete d.wNotes[name];
    if(selected&&selected.kind==='w'&&selected.name===name) selected=null;
    save(); renderWaiters(); renderZones(); updateShiftBadge(); renderHalls();
  });

  return chip;
}
function renderWaiters(){ const r1=$('#wRow1'), r2=$('#wRow2'); r1.innerHTML=''; r2.innerHTML=''; db.waiters.shift1.forEach(n=>r1.appendChild(waiterChip(n))); db.waiters.shift2.forEach(n=>r2.appendChild(waiterChip(n))); }
function highlightWaiters(){ document.querySelectorAll('.wchip').forEach(el=>{ const n=el.querySelector('.w-name')?.textContent||''; if(selected && selected.kind==='w' && selected.name===n) el.classList.add('active'); else el.classList.remove('active'); }); }

function editNoteModal(name){
  const host=modal(); const d=dayData(); const cur=d.wNotes[name]||[];
  host.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">Комментарии для: <strong>${name}</strong></div>
    <div class="row" style="gap:6px;flex-wrap:wrap;margin-bottom:6px">
      ${NOTE_PRESETS.map(t=>`<label class="ctrl mini" style="display:inline-flex;gap:6px;align-items:center">
        <input type="checkbox" class="preset" value="${t.replace(/"/g,'&quot;')}" ${cur.includes(t)?'checked':''}/> ${(NOTE_EMOJI[t]||'')} ${t}
      </label>`).join('')}
    </div>
    <div class="row" style="gap:6px;align-items:flex-end">
      <div style="flex:1">
        <div class="muted mini">Добавить свой (через ; можно несколько)</div>
        <input id="own" class="ctrl" placeholder="например: Усиление; Выход к 18:00"/>
      </div>
      <button id="ok" class="ctrl primary">OK</button>
      <button id="clr" class="ctrl">Очистить</button>
    </div>`;
  host.body.querySelector('#ok').onclick=()=>{
    const sel=[...host.body.querySelectorAll('.preset:checked')].map(x=>x.value);
    const own=(host.body.querySelector('#own').value||'').split(';').map(s=>s.trim()).filter(Boolean);
    d.wNotes[name]=[...sel, ...own];
    save(); renderWaiters(); renderZones(); host.close();
  };
  host.body.querySelector('#clr').onclick=()=>{ d.wNotes[name]=[]; save(); renderWaiters(); renderZones(); host.close(); };
}

/* Добавить официанта */
function addWaiterModal(){
  const host=modal();
  host.body.innerHTML=`
    <div class="row" style="gap:6px;align-items:flex-end">
      <div style="flex:1"><div class="muted mini">Имя</div><input id="nm" class="ctrl" placeholder="Например: Павел"/></div>
      <div><div class="muted mini">Смена</div><select id="sh" class="ctrl"><option value="1">1-я</option><option value="2">2-я</option></select></div>
      <button id="go" class="ctrl primary">Добавить</button><button id="cl" class="ctrl">Отмена</button>
    </div>`;
  host.body.querySelector('#go').onclick=()=>{ const nm=(host.body.querySelector('#nm').value||'').trim(); const sh=host.body.querySelector('#sh').value; if(!nm) return alert('Введите имя'); if(db.waiters.shift1.includes(nm)||db.waiters.shift2.includes(nm)) return alert('Такое имя уже есть'); if(sh==='1') db.waiters.shift1.push(nm); else db.waiters.shift2.push(nm); save(); renderWaiters(); host.close(); };
  host.body.querySelector('#cl').onclick=host.close;
}

/* ===== Банкет ===== */
function renderBanquets(){
  const p=$('#banquetPanel'); p.innerHTML='';
  dayData().banquets.forEach(b=>{
    const chip=renderBanquetChip(b,false,
      ()=>{ const d=dayData(); Object.values(d.assign).forEach(zmap=>{ Object.keys(zmap).forEach(z=>{ zmap[z]=(zmap[z]||[]).filter(e=>!(e.t==='b'&&e.id===b.id)); }); }); d.banquets=d.banquets.filter(x=>x.id!==b.id); save(); renderBanquets(); renderZones(); },
      ()=> editBanquetModal(b)
    ); p.appendChild(chip);
  });
}
function addBanquetModal(){ openBanquetModal(); }
function editBanquetModal(b){ openBanquetModal(b); }
function openBanquetModal(existing=null){
  const host=modal(); const halls=Object.keys(db.halls); const hallOpts=halls.map(h=>`<option>${h}</option>`).join('');
  const b = existing || {type:'ДР', people:10, note:'', place:{hall:halls[0], zone:(db.halls[halls[0]]||[])[0]}};
  host.body.innerHTML=`
    <div class="row" style="flex-wrap:wrap;gap:8px">
      <div><div class="muted mini">Мероприятие</div><select id="bType" class="ctrl">${BANQUET_TYPES.map(t=>`<option ${t===b.type?'selected':''}>${t}</option>`).join('')}</select></div>
      <div><div class="muted mini">Кол-во</div><input id="bPeople" class="ctrl" type="number" min="1" inputmode="numeric" value="${b.people||''}" placeholder="25"/></div>
      <div><div class="muted mini">Зал</div><select id="bHall" class="ctrl">${hallOpts}</select></div>
      <div><div class="muted mini">Зона</div><select id="bZone" class="ctrl"></select></div>
      <div style="flex:1 1 100%"><div class="muted mini">Комментарий</div><input id="bNote" class="ctrl" placeholder="Пожелания, тайминг..." value="${(b.note||'').replace(/"/g,'&quot;')}"/></div>
      <div class="row" style="gap:8px;margin-top:4px"><button id="bOk" class="ctrl primary">${existing?'Сохранить':'Добавить'}</button><button id="bCancel" class="ctrl">Отмена</button></div>
    </div>`;
  const hallSel=host.body.querySelector('#bHall'), zoneSel=host.body.querySelector('#bZone');
  hallSel.value=b.place?.hall||halls[0];
  function fill(){ zoneSel.innerHTML=''; (db.halls[hallSel.value]||[]).forEach(z=>{ const o=document.createElement('option'); o.textContent=z; zoneSel.appendChild(o); }); zoneSel.value = (b.place?.zone && db.halls[hallSel.value]?.includes(b.place.zone)) ? b.place.zone : (db.halls[hallSel.value]||[])[0]; }
  hallSel.onchange=fill; fill();
  host.body.querySelector('#bOk').onclick=()=>{
    const t=host.body.querySelector('#bType').value;
    const p=parseInt(host.body.querySelector('#bPeople').value||'0',10);
    const note=host.body.querySelector('#bNote').value.trim();
    const hall=hallSel.value, zone=zoneSel.value;
    if(!(p>0)) return alert('Укажите количество человек');
    const d=dayData();
    if(existing){
      existing.type=t; existing.people=p; existing.note=note; existing.place={hall,zone};
      Object.values(d.assign).forEach(zmap=>{ Object.keys(zmap).forEach(z=>{ zmap[z]=(zmap[z]||[]).filter(e=>!(e.t==='b'&&e.id===existing.id)); }); });
      d.assign[hall] ||= {}; d.assign[hall][zone] ||= []; d.assign[hall][zone].push({t:'b', id:existing.id});
    }else{
      const id='b'+Math.random().toString(36).slice(2);
      const rec={id,type:t,people:p,note,place:{hall,zone}};
      d.banquets.push(rec); d.assign[hall] ||= {}; d.assign[hall][zone] ||= []; d.assign[hall][zone].push({t:'b',id});
    }
    save(); renderBanquets(); renderZones(); host.close();
  };
  host.body.querySelector('#bCancel').onclick=host.close;
}

/* ===== Завтраки ===== */
$('#breakfastBtn').onclick=()=>openBreakfasts();
function openBreakfasts(){
  const host=modal(); const k=curDay();
  const all=[...db.waiters.shift1,...db.waiters.shift2];
  const set=new Set(db.breakfasts[k]||[]);
  host.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">График завтраков (☕)</div>
    <div class="row" style="gap:6px">
      <div><div class="muted mini">Дата</div><input id="brDate" class="ctrl" type="date" value="${k}"/></div>
      <button class="ctrl mini" id="sendBr">Отправить завтраки</button>
    </div>
    <div style="margin-top:6px" id="names"></div>
    <div class="muted mini" style="margin-top:6px">Отметь имена — им будет поставлен статус «Завтрак».</div>`;
  const hostNames=host.body.querySelector('#names');
  function renderNames(){
    hostNames.innerHTML='';
    all.forEach(n=>{
      const label=document.createElement('label'); label.style.display='inline-flex'; label.style.alignItems='center'; label.style.gap='6px'; label.style.margin='4px 8px 0 0';
      const box=document.createElement('input'); box.type='checkbox'; box.checked=set.has(n);
      box.onchange=()=>{ box.checked?set.add(n):set.delete(n); persist(); };
      label.appendChild(box); label.appendChild(document.createTextNode(n)); hostNames.appendChild(label);
    });
  }
  function persist(){
    const date=host.body.querySelector('#brDate').value;
    db.breakfasts[date]=Array.from(set);
    save();
  }
  host.body.querySelector('#brDate').onchange=(e)=>{ const date=e.target.value; const arr=db.breakfasts[date]||[]; set.clear(); arr.forEach(x=>set.add(x)); renderNames(); };
  host.body.querySelector('#sendBr').onclick=()=>{
    const date=host.body.querySelector('#brDate').value;
    const arr=db.breakfasts[date]||[];
    const msg = `☕ Официант на завтраках — ${arr.join(', ')||'—'}. (${fmtDate(date)} ${weekday(date)})`;
    const url='https://wa.me/?text='+encodeURIComponent(msg);
    window.open(url,'_blank');
  };
  renderNames();
}

/* ===== Экспорт / WhatsApp ===== */
function buildMessage(){
  const iso=curDay(), d=dayData(), lines=[];
  lines.push('Добрый день, друзья!');
  lines.push(`${fmtDate(iso)} (${weekday(iso)})`);
  lines.push(`В смене ${countUniqueAssigned()} человек. 🕺`);

  if(d.banquets.length===0) lines.push('Банкеты: 0');
  else{
    lines.push('Банкеты:');
    d.banquets.forEach(b=>lines.push('• '+banquetTitle(b)));
  }

  const br = db.breakfasts[iso]||[];
  if(br.length){ lines.push(`☕ Официант на завтраках — ${br.join(', ')}.`); }

  Object.keys(d.assign).forEach(h=>{
    const zones=d.assign[h]; const non=Object.keys(zones).filter(z=>(zones[z]||[]).length>0);
    if(!non.length) return; lines.push('');
    lines.push(`${(HALL_ICONS[h]||'🏠')} *${h}*`);
    non.forEach(z=>{
      const arr=zones[z];
      const text=arr.map(e=>{
        if(e.t==='w'){
          const notes=(d.wNotes[e.name]||[]);
          const t=notes.length?`${e.name} (${notes.join('; ')})`:e.name;
          return t;
        }
        const bb=d.banquets.find(x=>x.id===e.id); return bb?(`${BANQUET_META[bb.type]?.ico||'🎈'} ${bb.type} ${bb.people}чел`):'Банкет';
      }).join(', ');
      const zico = ZONE_ICONS[z]||'•';
      lines.push(`${zico} ${z}: ${text}`);
    });
  });

  if(d.extraText){ lines.push(''); lines.push(d.extraText); }
  lines.push(''); lines.push('Всем хорошей смены и больших чаевых! 💵');
  return lines.join('\n');
}
function sendWhatsApp(){ const txt=buildMessage(); const app='whatsapp://send?text='+encodeURIComponent(txt); const web='https://wa.me/?text='+encodeURIComponent(txt); const a=document.createElement('a'); a.href=app; document.body.appendChild(a); a.click(); setTimeout(()=>{ window.open(web,'_blank'); a.remove(); },300); }
function sendPlan(){ const txt=`Схема основного зала:\n${location.origin+location.pathname.replace(/[^/]*$/,'')}oz-scheme.png`; const url='https://wa.me/?text='+encodeURIComponent(txt); window.open(url,'_blank'); }

function saveToFile(){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`rota-${curDay()}.json`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0); }
function importFromFile(file){ const r=new FileReader(); r.onload=()=>{ try{
  const obj=JSON.parse(r.result);
  if(obj&&obj.waiters&&obj.halls&&obj.data){ db=obj; purgeOld(); save(); renderAll(); alert('Импортирован полный бэкап.'); return; }
  if(obj&&(obj.assign||obj.banquets||obj.extraText!==undefined||obj.wNotes)){
    const k=curDay(); db.data[k]={assign:obj.assign||{},banquets:obj.banquets||[],extraText:obj.extraText||'',wNotes:obj.wNotes||{},ozCustom:null,ozScheme:[]};
    purgeOld(); save(); renderAll(); alert('Импортированы данные текущего дня.'); return;
  }
  alert('Неизвестный формат JSON.');
}catch(e){ alert('Ошибка импорта: '+e.message); } }; r.readAsText(file); }

/* ===== Счётчики/статистика ===== */
function countUniqueAssigned(){ const d=dayData(); const used=new Set(); Object.values(d.assign).forEach(zmap=>{ Object.values(zmap).forEach(arr=>{ arr.filter(x=>x.t==='w').forEach(x=>used.add(x.name)); }); }); return used.size; }
function updateShiftBadge(){ $('#shiftBadge').textContent=`В смене ${countUniqueAssigned()} человек`; }

function showLayout(){
  const d=dayData(); const host=modal();
  const lines=[];
  Object.keys(d.assign).forEach(h=>{
    const zones=d.assign[h]; const non=Object.keys(zones).filter(z=>(zones[z]||[]).length>0);
    if(!non.length) return; lines.push(`<div style="margin:6px 0 2px"><strong>${(HALL_ICONS[h]||'🏠')} ${h}</strong></div>`);
    non.forEach(z=>{
      const arr=zones[z];
      const text=arr.map(e=>{
        if(e.t==='w'){
          const notes=(d.wNotes[e.name]||[]); const t=notes.length?`${e.name} <span class="muted">(${notes.join('; ')})</span>`:e.name;
          return t;
        }
        const b=d.banquets.find(x=>x.id===e.id); return b?banquetTitle(b):'Банкет';
      }).join(', ');
      lines.push(`<div>${(ZONE_ICONS[z]||'•')} ${z}: ${text||'—'}</div>`);
    });
  });
  host.body.innerHTML=`<div class="muted mini" style="margin-bottom:6px">Расстановка на ${fmtDate(curDay())}</div>${lines.join('')||'Нет назначений' }<div class="row" style="justify-content:flex-end;margin-top:8px"><button class="ctrl mini" id="ok">OK</button></div>`;
  host.body.querySelector('#ok').onclick=host.close;
}

function showStats(){
  const until=curDay();
  const halls=Object.keys(db.halls);
  const stat1 = {}, stat2 = {};

  Object.keys(db.data).filter(k=>k<=until).forEach(k=>{
    const d=db.data[k];
    const names1=new Set(db.waiters.shift1);
    Object.keys(d.assign).forEach(h=>{
      Object.values(d.assign[h]).forEach(arr=>{
        const uniq=new Set(arr.filter(e=>e.t==='w').map(e=>e.name));
        uniq.forEach(n=>{
          const bucket = names1.has(n)?stat1:stat2;
          bucket[n] ||= {total:0, halls:{}};
          bucket[n].total++;
          bucket[n].halls[h] = (bucket[n].halls[h]||0)+1;
        });
      });
    });
  });

  function renderBucket(title, bucket){
    const rows=Object.entries(bucket).sort((a,b)=>b[1].total-a[1].total).map(([n,st])=>{
      const {bg}=colorFor(n);
      const hallsStr = halls.map(h=> st.halls[h] ? `${h}: ${st.halls[h]}` : '').filter(Boolean).join(' | ');
      return `<div class="row" style="gap:8px;align-items:center"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${bg}"></span><strong>${n}</strong><span class="muted">— всего: ${st.total}</span><span class="muted">${hallsStr}</span></div>`;
    }).join('') || '—';
    return `<div style="margin-top:8px"><div><strong>${title}</strong></div>${rows}</div>`;
  }

  const host=modal();
  host.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">Статистика до ${fmtDate(until)}</div>
    ${renderBucket('Смена 1', stat1)}
    ${renderBucket('Смена 2', stat2)}
    <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="ctrl mini" id="ok">OK</button></div>`;
  host.body.querySelector('#ok').onclick=host.close;
}

/* ===== Тема ===== */
function applyTheme(){
  const t=db.ui?.theme||'light'; document.documentElement.removeAttribute('data-theme');
  if(t==='dark') document.documentElement.setAttribute('data-theme','dark');
  if(t==='daltonic') document.documentElement.setAttribute('data-theme','daltonic');
  $('#themeSel').value=t;
}

/* ===== Инициализация ===== */
function renderAll(){ renderTop(); renderHalls(); renderZones(); renderWaiters(); renderBanquets(); updateShiftBadge(); applyTheme(); }

document.addEventListener('DOMContentLoaded', ()=>{
  // дата
  const dEl=$('#date'); dEl.value=dEl.value||todayISO(); dEl.onchange=()=>{ renderAll(); save(); };
  // тема
  $('#themeSel').onchange=(e)=>{ db.ui=db.ui||{}; db.ui.theme=e.target.value; save(); applyTheme(); };

  renderAll();

  // кнопки
  $('#toggleShift2').onclick=()=>{ const w=$('#wRow2Wrap'); w.style.display=(w.style.display==='none')?'block':'none'; };
  $('#addWaiterBtn').onclick=addWaiterModal;
  $('#addBanquetBtn').onclick=addBanquetModal;
  $('#sendBtn').onclick=sendWhatsApp;
  $('#sendPlanBtn').onclick=sendPlan;
  $('#layoutBtn').onclick=showLayout;
  $('#statsBtn').onclick=showStats;
  $('#addTextBtn').onclick=()=>{ const host=modal(); host.body.innerHTML=`<div class="muted mini" style="margin-bottom:6px">Добавить текст в конец сообщения</div><textarea id="x" class="ctrl" rows="4" style="width:100%">${dayData().extraText||''}</textarea><div class="row" style="gap:8px;margin-top:6px"><button id="ok" class="ctrl primary">OK</button><button id="cl" class="ctrl">Отмена</button></div>`; host.body.querySelector('#ok').onclick=()=>{ dayData().extraText=host.body.querySelector('#x').value||''; save(); host.close(); }; host.body.querySelector('#cl').onclick=host.close; };
  $('#saveBtn').onclick=saveToFile;
  $('#refreshBtn').onclick=()=>location.reload();
  $('#resetBtn').onclick=()=>{ if(!confirm('Очистить всю информацию за выбранный день?')) return; const k=curDay(); db.data[k]={assign:{},banquets:[],extraText:'',wNotes:{},ozCustom:null,ozScheme:[]}; save(); renderAll(); };
  const fileInput=$('#importFile'); $('#importBtn').onclick=()=>fileInput.click(); fileInput.onchange=(e)=>{ const f=e.target.files&&e.target.files[0]; if(f) importFromFile(f); e.target.value=''; };

  // Регистрация SW (PWA)
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
});
})();
</script>
</body>
</html>

