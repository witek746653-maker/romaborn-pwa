<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (–º–æ–±. 15/10/15/60)</title>

<style>
  :root{
    --ink:#222; --line:#8b5e57; --panel:#fffdfc; --chip:#ffffff;
    --accent:#ffe9c4; --badge:#ffd84d; --muted:#6f6866;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100vh;font:14px/1.28 system-ui,-apple-system,Segoe UI,Roboto;color:var(--ink);background:#fff;overflow:hidden}
  button,input,select{font:inherit;color:inherit}

  /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
  .wrap{max-width:1000px;margin:0 auto;padding:8px;height:100vh;display:grid;grid-template-rows:auto auto 1fr;gap:8px}

  /* –º–æ–±–∏–ª—å–Ω—ã–π –ª—ç–π–∞—É—Ç —Ñ–∏–∫—Å –ø—Ä–æ—Ü–µ–Ω—Ç—ã */
  @media (max-width:760px){
    .wrap{padding:6px;gap:6px;grid-template-rows:15% 10% 15% 60%}
    .top{grid-row:1;min-height:0;overflow:auto}
    .halls{grid-row:2;min-height:0;overflow:auto}
    .waiters{grid-row:3;min-height:0;overflow:auto}
    .zones{grid-row:4;min-height:0;overflow:hidden;display:flex;flex-direction:column}
  }

  .box{border:2px solid var(--line);border-radius:8px;background:var(--panel)}
  .pad{padding:8px}
  .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}

  /* –∫–æ–º–ø–∞–∫—Ç-–∫–Ω–æ–ø–∫–∏ */
  .btn{border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:6px 8px;cursor:pointer}
  .btn.sm{padding:4px 6px;font-size:12px}
  .badge{border:2px solid var(--line);background:var(--badge);border-radius:999px;padding:4px 10px;font-weight:700;font-size:12px;color:#1f1a0f}
  .muted{color:var(--muted);font-size:12px}

  /* —à–∞–ø–∫–∞ */
  .top .controls{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .grow{flex:1 1 auto}
  .datecard{display:flex;flex-direction:column}
  .datecard input{padding:4px 6px;border:2px solid var(--line);border-radius:6px;background:#fff}

  /* –∑–∞–ª—ã (10%) */
  .hallbar{display:flex;gap:6px;overflow:auto}
  .hall{border:2px solid var(--line);background:#fff;border-radius:6px;padding:6px 8px;white-space:nowrap}
  .hall.active{background:var(--accent)}

  /* –æ—Ñ–∏—Ü–∏–∞–Ω—Ç—ã (15%) */
  .wlist{display:flex;flex-wrap:wrap;gap:6px}
  .wchip{border:2px solid var(--line);background:#fff;border-radius:8px;min-width:96px;max-width:200px;padding:4px}
  .wtop{display:flex;gap:6px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .nm{font-weight:700;flex:1;min-width:0}
  .icbtn{border:1px solid var(--line);background:#fff;border-radius:4px;padding:0 6px;height:18px;line-height:18px;cursor:pointer}
  .notes{font-size:11px;color:var(--muted);white-space:normal}

  /* –∑–æ–Ω—ã (60%) */
  .zonesHead{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
  .zonesBox{border:2px solid var(--line);border-radius:8px;background:#fff;padding:6px;overflow:auto}
  .zone{border:2px dashed var(--line);border-radius:6px;padding:6px;margin-top:6px}
  .slot{display:flex;flex-wrap:wrap;gap:6px}

  .assign{border:2px solid var(--line);border-radius:8px;padding:4px 6px;background:#fff;display:inline-flex;flex-direction:column;gap:2px;min-width:110px}
  .assign .row1{display:flex;gap:6px;align-items:center}
  .assign .x{border:none;background:none;font-weight:900;font-size:16px;line-height:1;cursor:pointer}
  .assign .small{font-size:11px;color:var(--muted)}

  /* –±–∞–Ω–∫–µ—Ç ‚Äì –æ–¥–Ω–∞ –∏–∫–æ–Ω–∫–∞ */
  .bchip{border:2px solid var(--line);border-radius:10px;padding:4px 6px;background:#fff;display:inline-flex;gap:6px;align-items:flex-start}
  .bico{font-size:16px}
  .btitle{font-weight:700}
  .bnote{font-size:11px;color:var(--muted)}

  /* –º–æ–¥–∞–ª–∫–∞ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:10px;z-index:50}
  .dlg{background:#fff;border:2px solid var(--line);border-radius:10px;max-width:95vw;max-height:95vh;overflow:auto}
  .dlg .pad{padding:10px}

  /* SVG-—Å—Ö–µ–º–∞ */
  .svgWrap{position:relative;flex:1;border:2px dashed var(--line);border-radius:8px;overflow:hidden}
  .plan{position:absolute;inset:0;width:100%;height:100%}
  .shape{cursor:pointer;stroke:#00000055;stroke-width:2;transition:filter .15s}
  .shape:hover{filter:brightness(1.06)}
  .soft{opacity:.45}
</style>
</head>
<body>
<div class="wrap">

  <!-- –®–ê–ü–ö–ê 15% -->
  <div class="top box pad">
    <div class="controls">
      <div class="datecard">
        <span class="muted">–î–∞—Ç–∞</span>
        <input id="date" type="date">
      </div>
      <div id="wday" class="btn sm">‚Äî</div>
      <div id="shiftBadge" class="badge">–í —Å–º–µ–Ω–∞ 0 —á–µ–ª–æ–≤–µ–∫</div>

      <button id="sendBtn" class="btn sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="sendPlanBtn" class="btn sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ö–µ–º—É</button>
      <button id="breakfastBtn" class="btn sm">–ì—Ä–∞—Ñ–∏–∫ –∑–∞–≤—Ç—Ä–∞–∫–æ–≤</button>

      <div class="grow"></div>

      <button id="addWaiterBtn" class="btn sm">–î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞</button>
      <button id="addBanquetBtn" class="btn sm">–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–∫–µ—Ç</button>
      <button id="saveBtn" class="btn sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="importBtn" class="btn sm">–ò–º–ø–æ—Ä—Ç</button>
      <input id="importFile" type="file" accept="application/json" hidden>
    </div>

    <div class="row" style="margin-top:6px">
      <div id="banquetPanel" class="row" style="gap:6px"></div>
    </div>
  </div>

  <!-- –ó–ê–õ–´ 10% (–±–µ–∑ –Ω–∞–¥–ø–∏—Å–∏ ¬´–ó–∞–ª—ã¬ª) -->
  <div class="halls box pad">
    <div id="hallBar" class="hallbar"></div>
  </div>

  <!-- –û–§–ò–¶–ò–ê–ù–¢–´ 15% -->
  <div class="waiters box pad">
    <div class="wlist" id="wRow1"></div>
    <button id="toggleShift2" class="btn sm" style="margin-top:6px">–°–º–µ–Ω–∞ 2</button>
    <div id="wRow2Wrap" style="display:none;margin-top:6px">
      <div class="wlist" id="wRow2"></div>
    </div>
  </div>

  <!-- –ó–û–ù–´ 60% -->
  <div class="zones box pad">
    <div class="zonesHead">
      <button id="tabList" class="btn sm">–°–ø–∏—Å–æ–∫ –∑–æ–Ω</button>
      <button id="tabDraw" class="btn sm">–†–∏—Å–æ–≤–∞—Ç—å</button>
      <button id="clearSelBtn" class="btn sm">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
      <div class="btn sm" id="zoneTitle">‚Äî</div>
    </div>

    <!-- —Å–ø–∏—Å–æ–∫ –∑–æ–Ω -->
    <div id="zonesBox" class="zonesBox" style="display:none"></div>

    <!-- —Å—Ö–µ–º–∞ -->
    <div class="svgWrap" id="svgWrap">
      <svg id="planSVG" class="plan" viewBox="0 0 1113 768" aria-label="–°—Ö–µ–º–∞ –∑–∞–ª–∞">
        <!-- —Ç–≤–æ—è —Å—Ö–µ–º–∞ –ø–æ–¥–ª–æ–∂–∫–æ–π (PNG/JPG) –ø–æ –∂–µ–ª–∞–Ω–∏—é ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å -->
        <image href="oz-scheme.png" x="0" y="0" width="1113" height="768" opacity="0.28"/>
        <g id="polysLayer"></g>
      </svg>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<template id="modalTpl">
  <div class="modal"><div class="dlg"><div id="mBody" class="pad"></div></div></div>
</template>

<script>
(function(){
'use strict';
const $=s=>document.querySelector(s), modalTpl=$('#modalTpl');
const STORAGE='rota-mobile-v10';

/* --------- –ë–ê–ó–ê --------- */
const DEFAULT_HALLS={
  '–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª':['–í–µ—Å—å –∑–∞–ª','–ó–æ–Ω–∞ –æ–∫–Ω–∞','5-—è –ª–∏–Ω–∏—è','–°—Ç–æ–ª—ã 7,8,9','–°—Ç–æ–ª—ã 10,11,12','–ü–æ–¥–∏—É–º'],
  '–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª':['–ú–ë–ó'],
  '–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã':['–í—Å–µ –í–ò–ü—ã','–ë–æ–ª—å—à–æ–π –í–ò–ü','–ú–∞–ª—ã–π –í–ò–ü','–ö–∞—é—Ç–∞','–õ–∏–µ–Ω–¥–∞'],
  '–õ–æ—Ñ—Ç':['–õ–æ—Ñ—Ç'],
  '–í–µ—Ä–∞–Ω–¥–∞':['–í–µ—Ä–∞–Ω–¥–∞ 1','–í–µ—Ä–∞–Ω–¥–∞ 2'],
  '–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞':['–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞']
};
const SH1=['–≠–ª–æ–Ω–∞','–ü–æ–ª–∏–Ω–∞','–ù–∞—Å—Ç—è','–í–∏–∫—Ç–æ—Ä','–ù–∞—Ç–∞–ª–∏ –ß.','–†–æ–º–∞','–ö—Å—é—à–∞'];
const SH2=['–Æ–ª—è','–ò–≥–æ—Ä—å','–ö–∞—Ç—è','–ù–∞—Ç–∞—à–∞ –í.','–ù–∞—Ç–∞—à–∞ –í–µ–ª.','–ê—Ä—Ç–µ–º','–ú–∞—à–∞','–ò–Ω–Ω–∞','–õ—ë—à–∞'];
const NOTE_PRESETS=['–ü–æ–º–æ—â—å –≤ –û–ó','–ü–æ–º–æ—â—å –Ω–∞ –í–ò–ü–∞—Ö','–ü–æ–º–æ—â—å –≤ –ú–ë–ó','–ü–æ–º–æ—â—å –Ω–∞ –í–µ—Ä–∞–Ω–¥–µ 1','–ü–æ–º–æ—â—å –Ω–∞ –í–µ—Ä–∞–Ω–¥–µ 2','–î–æ—Å—Ç–∞–≤–∫–∞','1-—ã–π –Ω–æ–º–µ—Ä','2-–æ–π –Ω–æ–º–µ—Ä'];
const BANQ_META={'–î–†':'üéÇ','–Æ–±–∏–ª–µ–π':'üéâ','–î–µ–Ω—å –ø–∞–º—è—Ç–∏':'üïØÔ∏è','–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤':'üè¢','–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è':'üé§','–°–≤–∞–¥—å–±–∞':'üíç'};
const BANQ_TYPES=Object.keys(BANQ_META);

function defaultDB(){ return {waiters:{shift1:[...SH1],shift2:[...SH2]}, halls:JSON.parse(JSON.stringify(DEFAULT_HALLS)), data:{}, breakfasts:{}, svg:{polys:[]}}; }
let db=load()||defaultDB();
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE));}catch{return null} }
function save(){ localStorage.setItem(STORAGE, JSON.stringify(db)); }

function todayISO(){ const z=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-z).toISOString().slice(0,10); }
function fmtDate(iso){ const [y,m,d]=iso.split('-'); return `${d}.${m}.${y}`; }
function weekdayShort(iso){ const d=new Date(iso+'T00:00'); return ['–≤—Å','–ø–Ω','–≤—Ç','—Å—Ä','—á—Ç','–ø—Ç','—Å–±'][d.getDay()]; }
function modal(){ const el=modalTpl.content.firstElementChild.cloneNode(true); const body=el.querySelector('#mBody'); function close(){ el.remove(); } el.addEventListener('click',e=>{ if(e.target===el) close(); }); document.body.appendChild(el); return {el,body,close}; }
function colorFor(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; const hue=h%360; const fg='#1f2937'; return {bg:`hsl(${hue} 70% 85%)`, fg}; }

function curDay(){ return $('#date').value||todayISO(); }
function dayData(){ const k=curDay(); db.data[k] ||= {assign:{},banquets:[],wNotes:{},extraText:''}; return db.data[k]; }
function ensureHallZone(h,z){ const d=dayData(); d.assign[h] ||= {}; d.assign[h][z] ||= []; return d.assign[h][z]; }

/* --------- –®–ê–ü–ö–ê / –ó–ê–õ–´ --------- */
let currentHall='–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª';
function renderTop(){ const iso=curDay(); $('#wday').textContent = `${fmtDate(iso)}`; $('#zoneTitle').textContent=currentHall; }
function renderHalls(){ const bar=$('#hallBar'); bar.innerHTML=''; Object.keys(db.halls).forEach(h=>{ const b=document.createElement('button'); b.className='hall'; b.textContent=h; if(h===currentHall) b.classList.add('active'); b.onclick=()=>{ currentHall=h; renderTop(); renderZones(); }; bar.appendChild(b); }); }

/* --------- –û–§–ò–¶–ò–ê–ù–¢–´ + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ) --------- */
let selected=null;
function renderWaiters(){
  const r1=$('#wRow1'), r2=$('#wRow2'); r1.innerHTML=''; r2.innerHTML='';
  db.waiters.shift1.forEach(n=>r1.appendChild(chip(n)));
  db.waiters.shift2.forEach(n=>r2.appendChild(chip(n)));

  function chip(name){
    const wrap=document.createElement('div'); wrap.className='wchip';
    const {bg,fg}=colorFor(name);
    const top=document.createElement('div'); top.className='wtop';
    const dot=document.createElement('div'); dot.className='dot'; dot.style.background=bg;
    const nm=document.createElement('div'); nm.className='nm'; nm.textContent=name; nm.style.color=fg;
    const eb=document.createElement('button'); eb.className='icbtn'; eb.textContent='‚úé';
    const xb=document.createElement('button'); xb.className='icbtn'; xb.textContent='√ó';
    top.append(dot,nm,eb,xb);
    const notes=document.createElement('div'); notes.className='notes'; notes.textContent=(dayData().wNotes[name]||[]).join('; ');
    wrap.append(top,notes);

    wrap.addEventListener('click',(e)=>{ if(e.target===eb||e.target===xb) return; selected=(selected&&selected.kind==='w'&&selected.name===name)?null:{kind:'w',name}; });
    eb.onclick=(e)=>{ e.stopPropagation(); editNotes(name); };
    xb.onclick=(e)=>{ e.stopPropagation(); if(!confirm('–£–¥–∞–ª–∏—Ç—å –∏–º—è?'))return; db.waiters.shift1=db.waiters.shift1.filter(x=>x!==name); db.waiters.shift2=db.waiters.shift2.filter(x=>x!==name); const d=dayData(); Object.values(d.assign).forEach(m=>Object.keys(m).forEach(z=>m[z]=m[z].filter(it=>!(it.t==='w'&&it.name===name)))); delete d.wNotes[name]; save(); renderWaiters(); renderZones(); updateBadge(); };

    return wrap;
  }
}
function editNotes(name){
  const host=modal(); const cur=new Set(dayData().wNotes[name]||[]);
  host.body.innerHTML=`<div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è <b>${name}</b></div><div id="list" style="margin:6px 0"></div><div class="row" style="justify-content:flex-end"><button class="btn sm" id="ok">OK</button><button class="btn sm" id="cl">–û—Ç–º–µ–Ω–∞</button></div>`;
  const list=host.body.querySelector('#list');
  NOTE_PRESETS.forEach(t=>{ const L=document.createElement('label'); L.style.marginRight='8px'; const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=cur.has(t); cb.onchange=()=>cb.checked?cur.add(t):cur.delete(t); L.append(cb,document.createTextNode(' '+t)); list.appendChild(L); });
  host.body.querySelector('#ok').onclick=()=>{ dayData().wNotes[name]=Array.from(cur); save(); renderWaiters(); renderZones(); host.close(); };
  host.body.querySelector('#cl').onclick=host.close;
}

/* --------- –ó–û–ù–´ (—Å–ø–∏—Å–æ–∫ + –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ) --------- */
function renderZones(){
  $('#zoneTitle').textContent=currentHall;
  const box=$('#zonesBox'); box.innerHTML='';
  (db.halls[currentHall]||[]).forEach(z=>{
    const div=document.createElement('div'); div.className='zone';
    div.innerHTML=`<b>${z}</b><div class="slot"></div>`;
    const slot=div.querySelector('.slot');
    const arr=ensureHallZone(currentHall,z);
    const D=dayData();
    const draw=()=>{
      slot.innerHTML='';
      arr.forEach((e,i)=>{
        if(e.t==='w'){
          const a=document.createElement('div'); a.className='assign';
          const {bg,fg}=colorFor(e.name); a.style.background=bg; a.style.color=fg;
          a.innerHTML=`<div class="row1"><span>${e.name}</span><button class="x">√ó</button></div><div class="small">${(D.wNotes[e.name]||[]).join('; ')}</div>`;
          a.querySelector('.x').onclick=()=>{ arr.splice(i,1); save(); draw(); updateBadge(); };
          slot.appendChild(a);
        }else{
          const b=D.banquets.find(x=>x.id===e.id); if(!b) return;
          const chip=document.createElement('div'); chip.className='assign';
          chip.innerHTML=`<div class="row1"><span>${BANQ_META[b.type]||'üéà'} <b>${b.type}</b> ‚Ä¢ ${b.people}</span><button class="x">√ó</button></div><div class="small">${(b.place?.hall||'')}${b.place?.zone?(' ‚Äî '+b.place.zone):''}${b.note?(' ‚Ä¢ '+b.note):''}</div>`;
          chip.querySelector('.x').onclick=()=>{ arr.splice(i,1); save(); draw(); };
          slot.appendChild(chip);
        }
      });
    };
    div.addEventListener('click',()=>{
      if(!selected) return;
      if(selected.kind==='w' && !arr.some(x=>x.t==='w'&&x.name===selected.name)){ arr.push({t:'w',name:selected.name}); }
      save(); draw(); updateBadge();
    });
    draw();
    box.appendChild(div);
  });
}

/* --------- SVG-–°–•–ï–ú–ê: –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –∑–æ–Ω—ã, –º—è–≥–∫–∞—è –∑–∞–ª–∏–≤–∫–∞ --------- */
const svg = ()=>document.getElementById('planSVG');
function toRGBA(hex,a){ const v=hex.replace('#',''); const r=parseInt(v.slice(0,2),16), g=parseInt(v.slice(2,4),16), b=parseInt(v.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }
function drawSVGPolys(){
  const layer=$('#polysLayer'); layer.innerHTML='';
  (db.svg.polys||[]).forEach((p,idx)=>{
    const el=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    el.setAttribute('points', p.points.map(q=>`${q.x/100*1113},${q.y/100*768}`).join(' '));
    el.setAttribute('fill', toRGBA(p.color||'#ffd84d', .45));
    el.classList.add('shape','soft');
    el.dataset.idx=idx; el.dataset.label=p.label;
    layer.appendChild(el);
  });
}
$('#polysLayer').addEventListener('click',(e)=>{
  const poly=e.target.closest('.shape'); if(!poly||!selected) return;
  const label=poly.dataset.label;
  const arr=ensureHallZone('–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª',label);
  if(selected.kind==='w' && !arr.some(x=>x.t==='w'&&x.name===selected.name)){ arr.push({t:'w',name:selected.name}); }
  save(); renderZones(); updateBadge();
});
let drawMode=false, curPts=[], curPath=null, rect=null;
$('#tabDraw').onclick=()=>{ drawMode=!drawMode; alert(drawMode?'–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ: –æ–±–≤–µ–¥–∏—Ç–µ –ø–∞–ª—å—Ü–µ–º –∑–æ–Ω—É.':'–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ'); };
$('#tabList').onclick=()=>{ const v=$('#zonesBox'); v.style.display = v.style.display==='none' ? 'block' : 'none'; };
$('#clearSelBtn').onclick=()=>{ selected=null; };

const wrap=$('#svgWrap');
wrap.addEventListener('pointerdown',(e)=>{
  if(!drawMode) return;
  e.preventDefault(); rect=wrap.getBoundingClientRect(); curPts=[];
  const {x,y}=rel(e); curPts.push(x,y);
  curPath=document.createElementNS('http://www.w3.org/2000/svg','polyline');
  curPath.setAttribute('points',''); curPath.setAttribute('stroke','#333'); curPath.setAttribute('stroke-width','2'); curPath.setAttribute('fill','none'); curPath.style.pointerEvents='none'; svg().appendChild(curPath); wrap.setPointerCapture(e.pointerId);
});
wrap.addEventListener('pointermove',(e)=>{
  if(!drawMode||!curPath) return; const {x,y}=rel(e); curPts.push(x,y); curPath.setAttribute('points', ptsStr(curPts));
});
wrap.addEventListener('pointerup',()=>{
  if(!drawMode||!curPath) return;
  const pts = toPairs(curPts).map(([px,py])=>({x:px*100,y:py*100}));
  curPath.remove(); curPath=null;
  if(pts.length<3){ drawMode=false; return; }
  askZone(pts);
});
function rel(e){ const cx=e.clientX, cy=e.clientY; return {x:(cx-rect.left)/rect.width, y:(cy-rect.top)/rect.height}; }
function ptsStr(a){ const out=[]; for(let i=0;i<a.length;i+=2) out.push((a[i]*1113)+','+(a[i+1]*768)); return out.join(' '); }
function toPairs(a){ const r=[]; for(let i=0;i<a.length;i+=2) r.push([a[i],a[i+1]]); return r; }
function askZone(points){
  const m=modal();
  m.body.innerHTML=`<div class="row"><div><div class="muted">–ù–∞–∑–≤–∞–Ω–∏–µ</div><input id="zn" class="btn sm" placeholder="–°—Ç–æ–ª—ã 1‚Äì3"></div><div><div class="muted">–¶–≤–µ—Ç</div><input id="zc" type="color" class="btn sm" value="#ffd84d"></div><button id="ok" class="btn sm">–°–æ–∑–¥–∞—Ç—å</button><button id="cl" class="btn sm">–û—Ç–º–µ–Ω–∞</button></div>`;
  m.body.querySelector('#ok').onclick=()=>{ const name=m.body.querySelector('#zn').value.trim(); const col=m.body.querySelector('#zc').value; if(!name) return; db.svg.polys.push({label:name,color:col,points}); if(!db.halls['–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'].includes(name)) db.halls['–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'].push(name); save(); drawSVGPolys(); renderZones(); m.close(); drawMode=false; };
  m.body.querySelector('#cl').onclick=()=>{ m.close(); drawMode=false; };
}

/* --------- –ë–ê–ù–ö–ï–¢–´ (–æ–¥–Ω–∞ –∏–∫–æ–Ω–∫–∞) --------- */
function renderBanquets(){
  const p=$('#banquetPanel'); p.innerHTML='';
  dayData().banquets.forEach(b=>{
    const s=document.createElement('span'); s.className='bchip';
    s.innerHTML=`<span class="bico">${BANQ_META[b.type]||'üéà'}</span><span><span class="btitle">${b.type} ‚Ä¢ ${b.people}</span>${b.note?`<div class="bnote">${b.place?.hall||''}${b.place?.zone?(' ‚Äî '+b.place.zone):''} ‚Ä¢ ${b.note}</div>`:`<div class="bnote">${b.place?.hall||''}${b.place?.zone?(' ‚Äî '+b.place.zone):''}</div>`}</span>`;
    const x=document.createElement('button'); x.className='icbtn'; x.textContent='√ó';
    x.onclick=()=>{ const d=dayData(); Object.values(d.assign).forEach(zm=>Object.keys(zm).forEach(z=>zm[z]=zm[z].filter(e=>!(e.t==='b'&&e.id===b.id)))); d.banquets=d.banquets.filter(x=>x.id!==b.id); save(); renderBanquets(); renderZones(); };
    s.appendChild(x); p.appendChild(s);
  });
}
$('#addBanquetBtn').onclick=()=>openBanquet();
function openBanquet(){
  const host=modal(); const halls=Object.keys(db.halls);
  host.body.innerHTML=`<div class="row"><div><div class="muted">–¢–∏–ø</div><select id="t" class="btn sm">${BANQ_TYPES.map(t=>`<option>${t}</option>`)}</select></div><div><div class="muted">–ö–æ–ª-–≤–æ</div><input id="p" class="btn sm" type="number" min="1" inputmode="numeric"></div><div><div class="muted">–ó–∞–ª</div><select id="h" class="btn sm">${halls.map(h=>`<option>${h}</option>`)}</select></div><div><div class="muted">–ó–æ–Ω–∞</div><select id="z" class="btn sm"></select></div><div style="flex:1"><div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><input id="n" class="btn sm"></div><button id="ok" class="btn sm">–î–æ–±–∞–≤–∏—Ç—å</button><button id="cl" class="btn sm">–û—Ç–º–µ–Ω–∞</button></div>`;
  const h=host.body.querySelector('#h'), z=host.body.querySelector('#z');
  const fill=()=>{ z.innerHTML=''; (db.halls[h.value]||[]).forEach(x=>{ const o=document.createElement('option'); o.textContent=x; z.appendChild(o); }); };
  h.onchange=fill; fill();
  host.body.querySelector('#ok').onclick=()=>{ const type=host.body.querySelector('#t').value; const people=parseInt(host.body.querySelector('#p').value||'0',10); const note=host.body.querySelector('#n').value.trim(); if(!(people>0)) return; const id='b'+Math.random().toString(36).slice(2); const hall=h.value, zone=z.value; const d=dayData(); d.banquets.push({id,type: type,people,note,place:{hall,zone}}); d.assign[hall] ||= {}; d.assign[hall][zone] ||= []; d.assign[hall][zone].push({t:'b',id}); save(); renderBanquets(); renderZones(); host.close(); };
  host.body.querySelector('#cl').onclick=host.close;
}

/* --------- –ì–†–ê–§–ò–ö –ó–ê–í–¢–†–ê–ö–û–í (–∫–æ–º–ø–∞–∫—Ç, –±–µ–∑ –¥–Ω—è –Ω–µ–¥–µ–ª–∏) --------- */
$('#breakfastBtn').onclick=()=>{
  const host=modal(); const now=new Date(curDay()+'T00:00'); let y=now.getFullYear(), m=now.getMonth();
  host.body.innerHTML=`<div class="row" style="justify-content:space-between"><button id="prev" class="btn sm">‚Üê</button><div id="lbl" class="btn sm"></div><button id="next" class="btn sm">‚Üí</button></div><div id="grid" style="margin-top:6px;display:grid;grid-template-columns:repeat(3,1fr);gap:6px"></div><div class="row" style="justify-content:flex-end;margin-top:6px"><button id="send" class="btn sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ—Å—è—Ü</button><button id="close" class="btn sm">–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  const lbl=host.body.querySelector('#lbl'), grid=host.body.querySelector('#grid');
  function render(){ lbl.textContent=new Date(y,m,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'}); grid.innerHTML=''; const last=new Date(y,m+1,0).getDate(); for(let d=1; d<=last; d++){ const iso=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const names=db.breakfasts[iso]||[]; const cell=document.createElement('div'); cell.className='box pad'; cell.style.fontSize='12px'; cell.innerHTML=`<div style="display:flex;justify-content:space-between"><b>${String(d).padStart(2,'0')}.${String(m+1).padStart(2,'0')}.${y}</b><span class="muted" style="font-size:11px;max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${names.join(', ')||'‚Äî'}</span></div><div class="row" style="justify-content:flex-end"><button class="btn sm">–ò–∑–º.</button></div>`; cell.querySelector('button').onclick=()=>editDay(iso,names); grid.appendChild(cell);} }
  function editDay(iso,current){ const h=modal(); const all=[...db.waiters.shift1,...db.waiters.shift2]; const set=new Set(current||[]); h.body.innerHTML=`<div class="muted">${fmtDate(iso)}</div><div id="names" style="margin:6px 0;display:flex;flex-wrap:wrap;gap:6px"></div><div class="row" style="justify-content:flex-end"><button class="btn sm" id="ok">OK</button><button class="btn sm" id="cl">–û—Ç–º–µ–Ω–∞</button></div>`; const names=h.body.querySelector('#names'); all.forEach(n=>{ const L=document.createElement('label'); L.style.marginRight='6px'; const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=set.has(n); cb.onchange=()=>cb.checked?set.add(n):set.delete(n); L.append(cb,document.createTextNode(' '+n)); names.appendChild(L); }); h.body.querySelector('#ok').onclick=()=>{ db.breakfasts[iso]=Array.from(set); save(); render(); h.close(); }; h.body.querySelector('#cl').onclick=()=>h.close(); }
  host.body.querySelector('#prev').onclick=()=>{ m--; if(m<0){m=11;y--;} render(); };
  host.body.querySelector('#next').onclick=()=>{ m++; if(m>11){m=0;y++;} render(); };
  host.body.querySelector('#send').onclick=()=>{ const last=new Date(y,m+1,0).getDate(); const lines=[`‚òï –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≤—Ç—Ä–∞–∫–æ–≤ –∑–∞ ${new Date(y,m,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'})}:`]; for(let d=1; d<=last; d++){ const iso=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const arr=db.breakfasts[iso]||[]; if(!arr.length) continue; lines.push(`${fmtDate(iso)}: ${arr.join(', ')}`); } const url='https://wa.me/?text='+encodeURIComponent(lines.join('\n')); window.open(url,'_blank'); };
  host.body.querySelector('#close').onclick=host.close;
  render();
};

/* --------- –°–ß–Å–¢–ß–ò–ö / WA / –≠–∫—Å–ø–æ—Ä—Ç --------- */
function countUnique(){ const used=new Set(); const d=dayData(); Object.values(d.assign).forEach(m=>Object.values(m).forEach(arr=>arr.filter(x=>x.t==='w').forEach(x=>used.add(x.name)))); return used.size; }
function updateBadge(){ $('#shiftBadge').textContent=`–í —Å–º–µ–Ω–∞ ${countUnique()} —á–µ–ª–æ–≤–µ–∫`; }

function buildMessage(){
  const d=dayData(), iso=curDay(), lines=[];
  lines.push('–î–æ–±—Ä—ã–π –¥–µ–Ω—å, –¥—Ä—É–∑—å—è!');
  lines.push(`${fmtDate(iso)} (${weekdayShort(iso)})`);
  lines.push(`–í —Å–º–µ–Ω–∞ ${countUnique()} —á–µ–ª–æ–≤–µ–∫. üï∫`);
  if(!d.banquets.length) lines.push('–ë–∞–Ω–∫–µ—Ç—ã: 0'); else { lines.push('–ë–∞–Ω–∫–µ—Ç—ã:'); d.banquets.forEach(b=>lines.push(`‚Ä¢ ${b.type} ‚Ä¢ ${b.people} ‚Ä¢ ${(b.place?.zone||b.place?.hall||'‚Äî')}${b.note?` ‚Ä¢ ${b.note}`:''}`)); }
  Object.keys(d.assign).forEach(h=>{
    const zm=d.assign[h]; const keys=Object.keys(zm).filter(z=>zm[z]?.length); if(!keys.length) return;
    lines.push(''); lines.push(h);
    keys.forEach(z=>{ const t=zm[z].map(e=> e.t==='w'?e.name:`${BANQ_META[d.banquets.find(x=>x.id===e.id)?.type]||'üéà'} –±–∞–Ω–∫–µ—Ç`).join(', '); lines.push(`${z}: ${t}`); });
  });
  lines.push(''); lines.push('–í—Å–µ–º —Ö–æ—Ä–æ—à–µ–π —Å–º–µ–Ω—ã –∏ –±–æ–ª—å—à–∏—Ö —á–∞–µ–≤—ã—Ö! üíµ');
  return lines.join('\n');
}
function sendWhatsApp(){ const txt=buildMessage(); const app='whatsapp://send?text='+encodeURIComponent(txt); const web='https://wa.me/?text='+encodeURIComponent(txt); const a=document.createElement('a'); a.href=app; document.body.appendChild(a); a.click(); setTimeout(()=>{ window.open(web,'_blank'); a.remove(); },300); }
$('#sendBtn').onclick=sendWhatsApp;

/* –°—Ö–µ–º–∞ –∫–∞–∫ PNG */
async function sendPlanAsImage(){
  try{
    const s = new XMLSerializer().serializeToString(svg());
    const blobSvg=new Blob([s],{type:'image/svg+xml'}), url=URL.createObjectURL(blobSvg);
    const img=new Image(); await new Promise(res=>{ img.onload=res; img.src=url; });
    const canvas=document.createElement('canvas'); canvas.width=1113; canvas.height=768; const ctx=canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,1113,768); ctx.drawImage(img,0,0); URL.revokeObjectURL(url);
    const pngBlob=await new Promise(r=>canvas.toBlob(r,'image/png',0.92)); const file=new File([pngBlob],`schema-${fmtDate(curDay())}.png`,{type:'image/png'});
    if(navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file]}); } else { const u=URL.createObjectURL(pngBlob); window.open(u,'_blank'); setTimeout(()=>URL.revokeObjectURL(u),20000); }
  }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É: '+e.message); }
}
$('#sendPlanBtn').onclick=sendPlanAsImage;

/* –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç */
function saveToFile(){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`rota-${curDay()}.json`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0); }
$('#saveBtn').onclick=saveToFile;
$('#importBtn').onclick=()=>$('#importFile').click();
$('#importFile').onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.waiters&&obj.halls&&obj.data){ db=obj; save(); renderAll(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø'); } else { alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'); } }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); } }; r.readAsText(f); e.target.value=''; };

/* –î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞ */
$('#addWaiterBtn').onclick=()=>{
  const m=modal();
  m.body.innerHTML=`<div class="row"><div><div class="muted">–ò–º—è</div><input id="nm" class="btn sm" placeholder="–ò–º—è"></div><div><div class="muted">–°–º–µ–Ω–∞</div><select id="sh" class="btn sm"><option value="1">1</option><option value="2">2</option></select></div><button id="ok" class="btn sm">–î–æ–±–∞–≤–∏—Ç—å</button><button id="cl" class="btn sm">–û—Ç–º–µ–Ω–∞</button></div>`;
  m.body.querySelector('#ok').onclick=()=>{ const n=m.body.querySelector('#nm').value.trim(); const sh=m.body.querySelector('#sh').value; if(!n) return; if(db.waiters.shift1.includes(n)||db.waiters.shift2.includes(n)) return alert('–ï—Å—Ç—å —Ç–∞–∫–æ–µ –∏–º—è'); sh==='1'?db.waiters.shift1.push(n):db.waiters.shift2.push(n); save(); renderWaiters(); m.close(); };
  m.body.querySelector('#cl').onclick=()=>m.close();
};

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#date').value = $('#date').value||todayISO();
  $('#date').onchange=()=>{ renderAll(); save(); };
  $('#toggleShift2').onclick=()=>{ const w=$('#wRow2Wrap'); w.style.display = w.style.display==='none' ? 'block' : 'none'; };
  renderAll();
});
function renderAll(){ renderTop(); renderHalls(); renderWaiters(); renderZones(); drawSVGPolys(); updateBadge(); }
})();
</script>
</body>
</html>
