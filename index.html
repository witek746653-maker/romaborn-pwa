<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Äî –º–æ–±–∏–ª—å–Ω–∞—è SVG</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffe9c4">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --ink:#2c2a29;--bg:#ffffff;--panel:#fffdfc;--line:#8b5e57;--muted:#7a6662;
    --accent:#f5e6da;--active:#ffe9c4;--badge:#ffd84d;--chip:#ffffff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.28 system-ui,-apple-system,Segoe UI,Roboto;height:100vh;overflow:hidden}
  button,input,select,textarea{font:inherit;color:inherit}

  /* –û–±—â–∏–µ –±–ª–æ–∫–∏ */
  .box{border:2px solid var(--line);border-radius:6px;background:var(--panel)}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pad{padding:8px}
  .ctrl{border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:6px 10px;cursor:pointer}
  .ctrl.primary{background:var(--accent)}
  .mini{font-size:12px;padding:4px 8px}
  .muted{color:var(--muted)}
  .badge{border:2px solid var(--line);background:var(--badge);color:#1f1a0f;border-radius:20px;padding:6px 12px;font-weight:700}
  .pill{border:2px solid var(--line);background:var(--chip);border-radius:20px;padding:6px 10px;cursor:pointer}

  /* –ö–æ–º–ø–æ–Ω–æ–≤–∫–∞ –¥–µ—Å–∫—Ç–æ–ø */
  .wrap{max-width:980px;margin:0 auto;padding:8px}
  .main{display:grid;grid-template-columns:1fr 1.2fr;gap:10px}
  .left{display:grid;gap:10px}

  /* –ö–æ–º–ø–æ–Ω–æ–≤–∫–∞ –º–æ–±–∏–ª—å–Ω–∞—è –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫—Ä–æ–ª–ª–∞: 20/10/30/40 */
  @media (max-width:760px){
    .wrap{height:100vh;display:grid;grid-template-rows:20% 10% 30% 40%;gap:6px;padding:6px}
    .topbar.box{grid-row:1;min-height:0;overflow:auto}
    .hallsSec.box{grid-row:2;min-height:0;overflow:auto}
    .waitersSec{grid-row:3;min-height:0;overflow:auto}
    .zonesSec{grid-row:4;min-height:0;overflow:hidden;display:flex;flex-direction:column}
    .main{display:contents}
  }

  /* –®–∞–ø–∫–∞ */
  .topbar{display:grid;grid-template-columns:1fr;gap:8px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .grow{flex:1 1 auto}
  .wday{min-width:160px}

  /* –ó–∞–ª—ã */
  .halls{display:flex;flex-wrap:nowrap;gap:8px;overflow:auto;padding-bottom:2px}
  .hall-btn{position:relative;border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:6px 10px;cursor:pointer;white-space:nowrap}
  .hall-btn.active{background:var(--active)}
  .hall-count{position:absolute;right:-6px;top:-6px;background:var(--badge);border:2px solid var(--line);border-radius:12px;padding:2px 6px;font-size:11px;line-height:1;color:#1f1a0f}

  /* –û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã */
  .waiters{border:2px solid var(--line);border-radius:6px;padding:8px;background:var(--chip)}
  .w-row{display:flex;flex-wrap:wrap;gap:6px}
  .wchip{border:2px solid var(--line);background:var(--chip);border-radius:8px;min-width:100px;max-width:220px;padding:6px 6px 4px;display:inline-flex;flex-direction:column;align-items:flex-start;gap:2px;cursor:pointer}
  .wchip.active{outline:2px solid #0003}
  .w-main{display:flex;align-items:center;gap:6px;width:100%}
  .w-dot{width:10px;height:10px;border-radius:50%}
  .w-name{font-weight:600;flex:1}
  .w-tools{display:flex;gap:4px}
  .iconbtn{border:1px solid var(--line);background:var(--chip);border-radius:4px;padding:0 6px;line-height:18px;height:18px;cursor:pointer}
  .w-note{font-size:11px;color:var(--muted);white-space:normal;overflow:visible}

  /* –ó–æ–Ω—ã: —Å–ø–∏—Å–æ–∫ + —Å—Ö–µ–º–∞ */
  .zonesHead{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
  .tabs{display:flex;gap:6px}
  .tab{border:2px solid var(--line);background:var(--chip);border-radius:16px;padding:4px 10px;cursor:pointer}
  .tab.active{background:var(--active)}

  .zonesBox{border:2px solid var(--line);border-radius:6px;background:var(--chip);min-height:0;flex:1;overflow:auto;padding:8px}
  .zone{border:2px dashed var(--line);border-radius:6px;padding:8px;margin:8px 0}
  .zone .zhead{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .zone .slot{display:flex;flex-wrap:wrap;gap:6px}

  .assign{border:2px solid var(--line);border-radius:8px;padding:4px 6px;display:inline-flex;gap:4px;align-items:flex-start;flex-direction:column;min-width:110px;background:var(--chip)}
  .assign .row1{display:flex;gap:6px;align-items:center}
  .assign .nm{font-weight:600}
  .assign .small{font-size:11px;color:var(--muted)}
  .assign .x{border:none;background:none;font-weight:900;font-size:16px;line-height:1;cursor:pointer}

  /* –ë–∞–Ω–∫–µ—Ç-–ø–ª–∞—à–∫–∏ –∫–æ–º–ø–∞–∫—Ç */
  .banquets{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
  .b-chip{border:2px solid var(--line);border-radius:10px;padding:4px 6px;display:inline-flex;align-items:flex-start;gap:6px;color:var(--ink);background:var(--chip);min-width:0}
  .b-ico{font-size:16px;line-height:1;margin-top:1px}
  .b-body{display:flex;flex-direction:column;gap:1px;min-width:0}
  .b-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:210px}
  .b-note{font-size:11px;color:var(--muted);white-space:normal}
  .b-chip .x{border:none;background:none;font-weight:900;font-size:16px;line-height:1;cursor:pointer;margin-left:2px}

  /* SVG —Å—Ö–µ–º–∞ */
  .svgWrap{position:relative;height:100%;border:2px dashed var(--line);border-radius:6px;overflow:hidden;background:#fff}
  .svgToolbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
  .planSVG{position:absolute;inset:0;width:100%;height:100%}
  .zone-shape{cursor:pointer;transition:filter .15s,stroke-width .15s}
  .zone-shape:hover{filter:brightness(1.06);stroke-width:3}
  .tag{position:absolute;padding:6px 8px;border-radius:8px;font-size:14px;color:#111;background:rgba(255,255,0,.65);cursor:grab;touch-action:none;user-select:none}

  /* –ú–æ–¥–∞–ª–∫–∞ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:10px;z-index:50}
  .dialog{background:var(--chip);border:2px solid var(--line);border-radius:8px;max-width:95vw;max-height:95vh;overflow:auto}
  .dialog .pad{padding:10px}

  /* —Ç–µ–º—ã –±–∞–Ω–∫–µ—Ç–æ–≤ (–º—è–≥–∫–∏–µ) */
  .bt-DR {background:#ffe8e8}
  .bt-–Æ–±–∏–ª–µ–π {background:#e8f7ff}
  .bt-–î–µ–Ω—å\ –ø–∞–º—è—Ç–∏ {background:#f3f4f6}
  .bt-–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤ {background:#e8fff1}
  .bt-–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è {background:#fff7e6}
  .bt-–°–≤–∞–¥—å–±–∞ {background:#fff0f6}
</style>
</head>
<body>
<div class="wrap">

  <!-- –®–ê–ü–ö–ê (20%) -->
  <div class="topbar box pad">
    <div class="controls">
      <div class="ctrl">
        <div class="muted mini">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        <input id="date" type="date"/>
      </div>
      <div class="ctrl wday" id="wday">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏<br/>–ß–∏—Å–ª–æ.–ú–µ—Å—è—Ü.</div>
      <div id="shiftBadge" class="badge">–í —Å–º–µ–Ω–∞ 0 —á–µ–ª–æ–≤–µ–∫</div>
      <button class="ctrl" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="ctrl" id="sendPlanBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ö–µ–º—É</button>
      <button class="ctrl" id="breakfastBtn">–ì—Ä–∞—Ñ–∏–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫–∏</button>
      <div class="grow"></div>
      <button class="ctrl mini" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="ctrl mini" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
      <input id="importFile" type="file" accept="application/json" hidden/>
    </div>

    <div class="controls">
      <div class="muted">–ë–∞–Ω–∫–µ—Ç—ã</div>
      <div id="banquetPanel" class="banquets"></div>
      <button class="ctrl primary mini" id="addBanquetBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ó–ê–õ–´ (10%) -->
  <div class="hallsSec box pad">
    <div class="muted mini" style="margin-bottom:6px">–ó–∞–ª—ã</div>
    <div class="halls" id="hallBar"></div>
  </div>

  <!-- –û–§–ò–¶–ò–ê–ù–¢–´ (30%) -->
  <div class="waitersSec">
    <div class="box pad">
      <div class="row" style="justify-content:space-between">
        <div class="muted mini">–û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã</div>
        <button class="ctrl mini" id="addWaiterBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="muted mini">–°–º–µ–Ω–∞ 1</div>
      <div id="wRow1" class="w-row"></div>
      <button id="toggleShift2" class="ctrl mini" style="margin-top:6px">–°–º–µ–Ω–∞ 2</button>
      <div id="wRow2Wrap" style="display:none;margin-top:6px">
        <div class="muted mini">–°–º–µ–Ω–∞ 2</div>
        <div id="wRow2" class="w-row"></div>
      </div>
    </div>
  </div>

  <!-- –ó–û–ù–´ (40%) -->
  <div class="zonesSec">
    <div class="zonesHead">
      <div class="muted">–ó–æ–Ω—ã</div>
      <div class="tabs">
        <button class="tab active" id="tabList">–°–ø–∏—Å–æ–∫</button>
        <button class="tab" id="tabMap">–°—Ö–µ–º–∞</button>
        <button class="tab" id="tabDraw">–†–∏—Å–æ–≤–∞—Ç—å –∑–æ–Ω—É</button>
      </div>
      <div class="pill" id="zoneTitle">‚Äî</div>
      <div class="grow"></div>
      <div class="muted mini">–¢–∞–ø –ø–æ –∑–æ–Ω–µ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞/–±–∞–Ω–∫–µ—Ç</div>
    </div>

    <!-- LIST -->
    <div id="zonesBox" class="zonesBox"></div>

    <!-- SVG MAP -->
    <div id="mapBox" class="zonesBox" style="display:none;padding:6px">
      <div class="svgToolbar">
        <button class="ctrl mini" id="sendPngBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ö–µ–º—É</button>
        <button class="ctrl mini" id="clearSelBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
      </div>
      <div class="svgWrap" id="svgWrap">
        <svg id="planSVG" class="planSVG" viewBox="0 0 1000 700" aria-label="–°—Ö–µ–º–∞ –∑–∞–ª–∞">
          <g id="polysLayer"></g>
        </svg>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<template id="modalTpl">
  <div class="modal"><div class="dialog"><div class="pad" id="modalBody"></div></div></div>
</template>

<script>
(function(){
'use strict';

/* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã/–∏–∫–æ–Ω–∫–∏/–ø—Ä–µ—Å–µ—Ç—ã ===== */
const STORAGE='rota-mobile-v7';
const MAX_AGE_DAYS=60;
const DEFAULT_HALLS={
  '–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª':['–í–µ—Å—å –∑–∞–ª','–ó–æ–Ω–∞ –æ–∫–Ω–∞','5-—è –ª–∏–Ω–∏—è','–°—Ç–æ–ª—ã 7,8,9','–°—Ç–æ–ª—ã 10,11,12','–ü–æ–¥–∏—É–º'],
  '–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª':['–ú–ë–ó'],
  '–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã':['–í—Å–µ –í–ò–ü—ã','–ë–æ–ª—å—à–æ–π –í–ò–ü','–ú–∞–ª—ã–π –í–ò–ü','–ö–∞—é—Ç–∞','–õ–∏–µ–Ω–¥–∞'],
  '–õ–æ—Ñ—Ç':['–õ–æ—Ñ—Ç'],
  '–í–µ—Ä–∞–Ω–¥–∞':['–í–µ—Ä–∞–Ω–¥–∞ 1','–í–µ—Ä–∞–Ω–¥–∞ 2'],
  '–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞':['–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞']
};
const SH1=['–≠–ª–æ–Ω–∞','–ü–æ–ª–∏–Ω–∞','–ù–∞—Å—Ç—è','–í–∏–∫—Ç–æ—Ä','–ù–∞—Ç–∞–ª–∏ –ß.','–†–æ–º–∞','–ö—Å—é—à–∞'];
const SH2=['–Æ–ª—è','–ò–≥–æ—Ä—å','–ö–∞—Ç—è','–ù–∞—Ç–∞—à–∞ –í.','–ù–∞—Ç–∞—à–∞ –í–µ–ª.','–ê—Ä—Ç–µ–º','–ú–∞—à–∞','–ò–Ω–Ω–∞','–õ—ë—à–∞'];

const HALL_ICONS={'–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª':'üèõÔ∏è','–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª':'üéä','–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã':'üëë','–õ–æ—Ñ—Ç':'üß±','–í–µ—Ä–∞–Ω–¥–∞':'üå¥','–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞':'üç∑'};
const ZONE_ICONS={
  '–í–µ—Å—å –∑–∞–ª':'üèõÔ∏è','–ó–æ–Ω–∞ –æ–∫–Ω–∞':'ü™ü','5-—è –ª–∏–Ω–∏—è':'üìö','–°—Ç–æ–ª—ã 7,8,9':'üçΩÔ∏è','–°—Ç–æ–ª—ã 10,11,12':'üçΩÔ∏è','–ü–æ–¥–∏—É–º':'ü™ú',
  '–ú–ë–ó':'üéâ','–í—Å–µ –í–ò–ü—ã':'üëë','–ë–æ–ª—å—à–æ–π –í–ò–ü':'üî•','–ú–∞–ª—ã–π –í–ò–ü':'üìö','–ö–∞—é—Ç–∞':'üõû','–õ–∏–µ–Ω–¥–∞':'üåä','–í–µ—Ä–∞–Ω–¥–∞ 1':'üö≠','–í–µ—Ä–∞–Ω–¥–∞ 2':'üö¨','–õ–æ—Ñ—Ç':'üß±','–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞':'üç∑'
};
const BANQUET_META={
  '–î–†':{ico:'üéÇ',cls:'bt-DR'}, '–Æ–±–∏–ª–µ–π':{ico:'üéâ',cls:'bt-–Æ–±–∏–ª–µ–π'}, '–î–µ–Ω—å –ø–∞–º—è—Ç–∏':{ico:'üïØÔ∏è',cls:'bt-–î–µ–Ω—å –ø–∞–º—è—Ç–∏'},
  '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤':{ico:'üè¢',cls:'bt-–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤'}, '–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è':{ico:'üé§',cls:'bt-–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è'}, '–°–≤–∞–¥—å–±–∞':{ico:'üíç',cls:'bt-–°–≤–∞–¥—å–±–∞'},
};
const BANQUET_TYPES=Object.keys(BANQUET_META);
const NOTE_PRESETS=['–ü–æ–º–æ—â—å –≤ –û–ó','–ü–æ–º–æ—â—å –Ω–∞ –í–ò–ü–∞—Ö','–ü–æ–º–æ—â—å –≤ –ú–ë–ó','–ü–æ–º–æ—â—å –Ω–∞ –í–µ—Ä–∞–Ω–¥–µ 1','–ü–æ–º–æ—â—å –Ω–∞ –í–µ—Ä–∞–Ω–¥–µ 2','–î–æ—Å—Ç–∞–≤–∫–∞','1-—ã–π –Ω–æ–º–µ—Ä','2-–æ–π –Ω–æ–º–µ—Ä','–ü–æ—Å—É–¥–∞ –Ω–∞ —Ü–µ—Ö–∞','–ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤–æ–¥–æ–ø–∞–¥—ã','–ú–∏–Ω–∞–∂','–¢—Ä–∏–¥–∂–µ–∫–∏','–ö—É–ª–ª–µ—Ä–∞','–ö–∞–º–∏–Ω—ã'];
const NOTE_EMOJI={ '–ü–æ–º–æ—â—å –≤ –û–ó':'ü™ü','–ü–æ–º–æ—â—å –Ω–∞ –í–ò–ü–∞—Ö':'üëë','–ü–æ–º–æ—â—å –≤ –ú–ë–ó':'üéâ','–ü–æ–º–æ—â—å –Ω–∞ –í–µ—Ä–∞–Ω–¥–µ 1':'üö≠','–ü–æ–º–æ—â—å –Ω–∞ –í–µ—Ä–∞–Ω–¥–µ 2':'üö¨','–î–æ—Å—Ç–∞–≤–∫–∞':'üöö','1-—ã–π –Ω–æ–º–µ—Ä':'1Ô∏è‚É£','2-–æ–π –Ω–æ–º–µ—Ä':'2Ô∏è‚É£','–ü–æ—Å—É–¥–∞ –Ω–∞ —Ü–µ—Ö–∞':'üçΩÔ∏è','–ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤–æ–¥–æ–ø–∞–¥—ã':'üíß','–ú–∏–Ω–∞–∂':'üçΩÔ∏è','–¢—Ä–∏–¥–∂–µ–∫–∏':'üç¥','–ö—É–ª–ª–µ—Ä–∞':'üíß','–ö–∞–º–∏–Ω—ã':'üî•','–ó–∞–≤—Ç—Ä–∞–∫':'‚òï'};

const $=s=>document.querySelector(s), modalTpl=$('#modalTpl');

/* ===== –£—Ç–∏–ª–∏—Ç—ã ===== */
function todayISO(){ const z=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-z).toISOString().slice(0,10); }
function weekday(iso){ const d=new Date(iso+'T00:00'); return ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞'][d.getDay()]; }
function fmtDate(iso){ const [y,m,d]=iso.split('-'); return `${d}.${m}.${y}`; }
function modal(){ const host=modalTpl.content.firstElementChild.cloneNode(true); const body=host.querySelector('#modalBody'); function close(){ host.remove(); } host.addEventListener('click',e=>{ if(e.target===host) close(); }); document.body.appendChild(host); return {el:host,body,close}; }
function colorFor(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; const hue=h%360, sat=65, light=70; const fg=(light>60)?'#1f2937':'#fff'; return {bg:`hsl(${hue} ${sat}% ${light}%)`, fg}; }
function hex2rgba(hex, a){ const v=hex.replace('#',''); const r=parseInt(v.slice(0,2),16), g=parseInt(v.slice(2,4),16), b=parseInt(v.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }

/* ===== –ë–∞–∑–∞ ===== */
function defaultDB(){ return {waiters:{shift1:[...SH1],shift2:[...SH2]}, halls:JSON.parse(JSON.stringify(DEFAULT_HALLS)), data:{}, breakfasts:{}, ui:{}, svg:{polys:[]}}; }
let db=load()||defaultDB();
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE));}catch{return null} }
function save(){ localStorage.setItem(STORAGE, JSON.stringify(db)); }
function purgeOld(){
  const now=new Date(todayISO()+'T00:00'); const day=86400000;
  for(const k of Object.keys(db.data)){ const d=new Date(k+'T00:00'); if((now-d)/day>MAX_AGE_DAYS) delete db.data[k]; }
  for(const k of Object.keys(db.breakfasts)){ const d=new Date(k+'T00:00'); if((now-d)/day>MAX_AGE_DAYS) delete db.breakfasts[k]; }
}
purgeOld(); save();

function curDay(){ return $('#date').value||todayISO(); }
function dayData(){
  const k=curDay();
  const init={assign:{},banquets:[],extraText:'',wNotes:{},ozCustom:null};
  db.data[k] ||= init;
  for(const n of Object.keys(db.data[k].wNotes)){ if(typeof db.data[k].wNotes[n]==='string') db.data[k].wNotes[n]=db.data[k].wNotes[n]?[db.data[k].wNotes[n]]:[]; }
  return db.data[k];
}

/* ===== –í–µ—Ä—Ö/–∑–∞–ª—ã ===== */
let currentHall='–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª';
function renderTop(){ const iso=curDay(); $('#wday').innerHTML=`${weekday(iso)}<br>${fmtDate(iso)}.`; }
function hallCountsFor(dateISO){
  const d=db.data[dateISO]; if(!d) return {};
  const perHall={};
  Object.keys(d.assign).forEach(h=>{
    const used=new Set();
    Object.values(d.assign[h]).forEach(arr=>arr.filter(x=>x.t==='w').forEach(x=>used.add(x.name)));
    perHall[h]=used.size;
  });
  return perHall;
}
function renderHalls(){
  const bar=$('#hallBar'); bar.innerHTML='';
  const counts=hallCountsFor(curDay());
  Object.keys(db.halls).forEach(h=>{
    const b=document.createElement('button');
    b.className='hall-btn'; b.textContent=h; if(h===currentHall) b.classList.add('active');
    if(counts[h]){ const c=document.createElement('span'); c.className='hall-count'; c.textContent=counts[h]; b.appendChild(c); }
    b.onclick=()=>{ currentHall=h; renderHalls(); renderZones(); };
    bar.appendChild(b);
  });
}

/* ===== –û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã ===== */
let selected=null;
function waiterChip(name){
  const notes=dayData().wNotes[name]||[]; const {bg,fg}=colorFor(name);
  const chip=document.createElement('div'); chip.className='wchip'; if(selected&&selected.kind==='w'&&selected.name===name) chip.classList.add('active');
  const main=document.createElement('div'); main.className='w-main';
  const dot=document.createElement('div'); dot.className='w-dot'; dot.style.background=bg;
  const nm=document.createElement('div'); nm.className='w-name'; nm.textContent=name; nm.style.color=fg;
  const tools=document.createElement('div'); tools.className='w-tools';
  const edit=document.createElement('button'); edit.className='iconbtn'; edit.title='–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'; edit.textContent='‚úé';
  const del=document.createElement('button'); del.className='iconbtn'; del.title='–£–¥–∞–ª–∏—Ç—å –∏–º—è'; del.textContent='√ó';
  tools.append(edit,del); main.append(dot,nm,tools);
  const sub=document.createElement('div'); sub.className='w-note';
  sub.textContent = notes.map(n=> (NOTE_EMOJI[n]?NOTE_EMOJI[n]+' ':'')+n).join('; ');
  chip.append(main, sub);
  chip.addEventListener('click',(e)=>{ if(e.target===edit||e.target===del) return; selected=(selected&&selected.kind==='w'&&selected.name===name)?null:{kind:'w',name}; highlightWaiters(); });
  edit.addEventListener('click',(e)=>{ e.stopPropagation(); editNoteModal(name); });
  del.addEventListener('click',(e)=>{
    e.stopPropagation();
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å "${name}" –∏ —É–±—Ä–∞—Ç—å –∏–∑ –∑–æ–Ω?`)) return;
    db.waiters.shift1 = db.waiters.shift1.filter(n=>n!==name);
    db.waiters.shift2 = db.waiters.shift2.filter(n=>n!==name);
    const d=dayData();
    Object.values(d.assign).forEach(zmap=>{ Object.keys(zmap).forEach(z=>{ zmap[z]=zmap[z].filter(e=>!(e.t==='w'&&e.name===name)); }); });
    delete d.wNotes[name];
    if(selected&&selected.kind==='w'&&selected.name===name) selected=null;
    save(); renderWaiters(); renderZones(); updateShiftBadge(); renderHalls();
  });
  return chip;
}
function renderWaiters(){ const r1=$('#wRow1'), r2=$('#wRow2'); r1.innerHTML=''; r2.innerHTML=''; db.waiters.shift1.forEach(n=>r1.appendChild(waiterChip(n))); db.waiters.shift2.forEach(n=>r2.appendChild(waiterChip(n))); }
function highlightWaiters(){ document.querySelectorAll('.wchip').forEach(el=>{ const n=el.querySelector('.w-name')?.textContent||''; if(selected && selected.kind==='w' && selected.name===n) el.classList.add('active'); else el.classList.remove('active'); }); }

/* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∏–º–µ–Ω–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ) */
function editNoteModal(name){
  const host=modal(); const d=dayData(); const cur=d.wNotes[name]||[];
  host.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è: <strong>${name}</strong></div>
    <div class="row" style="gap:6px;flex-wrap:wrap;margin-bottom:6px">
      ${NOTE_PRESETS.map(t=>`<label class="ctrl mini" style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" class="preset" value="${t.replace(/"/g,'&quot;')}" ${cur.includes(t)?'checked':''}/> ${t}</label>`).join('')}
    </div>
    <div class="row" style="gap:6px;align-items:flex-end">
      <div style="flex:1"><div class="muted mini">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π (—á–µ—Ä–µ–∑ ; –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</div><input id="own" class="ctrl" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –£—Å–∏–ª–µ–Ω–∏–µ; –í—ã—Ö–æ–¥ –∫ 18:00"/></div>
      <button id="ok" class="ctrl primary">OK</button>
      <button id="clr" class="ctrl">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>`;
  host.body.querySelector('#ok').onclick=()=>{ const sel=[...host.body.querySelectorAll('.preset:checked')].map(x=>x.value); const own=(host.body.querySelector('#own').value||'').split(';').map(s=>s.trim()).filter(Boolean); d.wNotes[name]=[...sel, ...own]; save(); renderWaiters(); renderZones(); host.close(); };
  host.body.querySelector('#clr').onclick=()=>{ d.wNotes[name]=[]; save(); renderWaiters(); renderZones(); host.close(); };
}

/* ===== –ó–æ–Ω—ã: —Å–ø–∏—Å–æ–∫ ===== */
function ensureHallZone(h,z){ const d=dayData(); d.assign[h] ||= {}; d.assign[h][z] ||= []; return d.assign[h][z]; }
function banquetTitle(b){ const meta=BANQUET_META[b.type]||{ico:'üéà',cls:''}; const place = b.place ? (b.place.zone ? `${b.place.hall} ‚Äî ${b.place.zone}` : b.place.hall) : '‚Äî'; return `${meta.ico} ${b.type} ‚Ä¢ ${b.people} —á–µ–ª ‚Ä¢ ${place}${b.note?` ‚Ä¢ ${b.note}`:''}`; }
function renderBanquetChip(b, small=false, onDelete=null, onEdit=null){
  const meta=BANQUET_META[b.type]||{ico:'üéà',cls:''};
  const s=document.createElement('span'); s.className=`b-chip ${meta.cls}`;
  s.innerHTML = `<span class="b-ico">${meta.ico}</span><span class="b-body"><span class="b-title">${small?`${b.type} ‚Ä¢ ${b.people} ‚Ä¢ ${b.place?.zone||b.place?.hall||'‚Äî'}`:banquetTitle(b)}</span>${(b.note?`<span class="b-note">${b.note}</span>`:'')}</span>`;
  if(onEdit){ s.style.cursor='pointer'; s.onclick=onEdit; }
  const x=document.createElement('button'); x.className='x'; x.title='–£–¥–∞–ª–∏—Ç—å'; x.textContent='√ó';
  x.onclick=(ev)=>{ ev.stopPropagation(); onDelete && onDelete(); };
  s.appendChild(x);
  return s;
}
function renderZones(){
  const d=dayData();
  $('#zoneTitle').textContent=currentHall;
  const box=$('#zonesBox'); box.innerHTML='';
  (db.halls[currentHall]||[]).forEach(z=>{
    const wrap=document.createElement('div'); wrap.className='zone';
    const head=document.createElement('div'); head.className='zhead';
    head.innerHTML=`<strong>${(ZONE_ICONS[z]||'‚Ä¢')} ${z}</strong>`;
    wrap.appendChild(head);
    const slot=document.createElement('div'); slot.className='slot'; wrap.appendChild(slot);

    const draw=()=>{
      slot.innerHTML='';
      const arr=ensureHallZone(currentHall,z);
      arr.forEach((e,i)=>{
        if(e.t==='w'){
          const item=document.createElement('div'); item.className='assign';
          const {bg,fg}=colorFor(e.name);
          item.style.background=bg; item.style.color=fg;
          const row=document.createElement('div'); row.className='row1';
          row.innerHTML=`<span class="nm">${e.name}</span> <button class="x" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>`;
          const notes=(d.wNotes[e.name]||[]); const under=document.createElement('div'); under.className='small'; under.textContent=notes.join('; ');
          item.appendChild(row); if(notes.length) item.appendChild(under);
          row.querySelector('.x').onclick=()=>{ arr.splice(i,1); save(); draw(); updateShiftBadge(); renderHalls(); };
          slot.appendChild(item);
        }else{
          const bb = d.banquets.find(x=>x.id===e.id); if(!bb) return;
          const chip = renderBanquetChip(bb,true, ()=>{ arr.splice(i,1); save(); draw(); renderBanquets(); }, ()=> editBanquetModal(bb) );
          slot.appendChild(chip);
        }
      });
    };
    draw();

    wrap.addEventListener('click',()=>{
      if(!selected) return;
      const arr=ensureHallZone(currentHall,z);
      if(selected.kind==='w'){
        if(!arr.some(x=>x.t==='w'&&x.name===selected.name)){ arr.push({t:'w',name:selected.name}); }
      }else if(selected.kind==='b'){
        if(!arr.some(x=>x.t==='b'&&x.id===selected.id)){
          arr.push({t:'b',id:selected.id});
          const b=d.banquets.find(x=>x.id===selected.id); if(b){ b.place={hall:currentHall,zone:z}; }
        }
      }
      save(); draw(); updateShiftBadge(); renderHalls();
    });

    box.appendChild(wrap);
  });
}

/* ===== –ó–æ–Ω—ã: SVG-—Å—Ö–µ–º–∞ + —Ä–∏—Å–æ–≤–∞–Ω–∏–µ ===== */
const svg = ()=>document.getElementById('planSVG');
function drawSVGPolys(){
  const layer=document.getElementById('polysLayer'); layer.innerHTML='';
  (db.svg.polys||[]).forEach((p,idx)=>{
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    const pts = p.points.map(q=>`${q.x/100*1000},${q.y/100*700}`).join(' ');
    poly.setAttribute('points', pts);
    poly.setAttribute('data-idx', idx);
    poly.setAttribute('data-label', p.label);
    poly.setAttribute('fill', hex2rgba(p.color||'#ffd84d', 0.45));
    poly.setAttribute('stroke', '#00000055');
    poly.setAttribute('stroke-width','2');
    poly.classList.add('zone-shape');
    layer.appendChild(poly);
  });
}
function attachSVGHandlers(){
  const layer=document.getElementById('polysLayer');
  layer.onclick=(e)=>{
    const poly=e.target.closest('.zone-shape'); if(!poly) return;
    const label=poly.getAttribute('data-label');
    if(!selected) return;
    const arr=ensureHallZone('–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª', label);
    if(selected.kind==='w'){
      if(!arr.some(x=>x.t==='w'&&x.name===selected.name)) arr.push({t:'w',name:selected.name});
    }else if(selected.kind==='b'){
      if(!arr.some(x=>x.t==='b'&&x.id===selected.id)){ arr.push({t:'b',id:selected.id}); const b=dayData().banquets.find(x=>x.id===selected.id); if(b){ b.place={hall:'–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª',zone:label}; } }
    }
    save(); renderZones(); updateShiftBadge(); renderHalls();
  };
  // –¥–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª–∏—Ç—å
  let hold=0;
  layer.addEventListener('pointerdown',(e)=>{ const poly=e.target.closest('.zone-shape'); if(!poly) return; const idx=+poly.getAttribute('data-idx'); hold=setTimeout(()=>editPoly(idx),600); });
  layer.addEventListener('pointerup',()=>clearTimeout(hold));
  layer.addEventListener('pointerleave',()=>clearTimeout(hold));
}
function editPoly(idx){
  const p=db.svg.polys[idx];
  const h=modal();
  h.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">–ó–æ–Ω–∞ –ø–æ —Å—Ö–µ–º–µ</div>
    <div class="row" style="gap:6px">
      <div><div class="muted mini">–ù–∞–∑–≤–∞–Ω–∏–µ</div><input id="zn" class="ctrl" value="${p.label.replace(/"/g,'&quot;')}"/></div>
      <div><div class="muted mini">–¶–≤–µ—Ç</div><input id="zc" type="color" class="ctrl" value="${p.color||'#ffd84d'}"/></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px;gap:6px">
      <button class="ctrl primary mini" id="ok">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="ctrl mini" id="del">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="ctrl mini" id="cl">–û—Ç–º–µ–Ω–∞</button>
    </div>`;
  h.body.querySelector('#ok').onclick=()=>{
    const name=h.body.querySelector('#zn').value.trim(); const col=h.body.querySelector('#zc').value;
    if(!name) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
    if(name!==p.label){
      const hall='–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'; const d=dayData();
      d.assign[hall] ||= {}; d.assign[hall][name] ||= [];
      (d.assign[hall][p.label]||[]).forEach(x=> d.assign[hall][name].push(x));
      delete d.assign[hall][p.label];
      const list=db.halls[hall]; const i=list.indexOf(p.label); if(i>=0) list.splice(i,1,name);
      p.label=name;
    }
    p.color=col; save(); drawSVGPolys(); renderZones(); h.close();
  };
  h.body.querySelector('#del').onclick=()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–æ–Ω—É –∏ –µ—ë –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è?')) return;
    const hall='–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'; const d=dayData();
    delete (d.assign[hall]||{})[p.label];
    const list=db.halls[hall]; const i=list.indexOf(p.label); if(i>=0) list.splice(i,1);
    db.svg.polys.splice(idx,1); save(); drawSVGPolys(); renderZones(); h.close();
  };
  h.body.querySelector('#cl').onclick=()=>h.close();
}

/* –†–µ–∂–∏–º ¬´–†–∏—Å–æ–≤–∞—Ç—å –∑–æ–Ω—É¬ª (lasso) */
let drawMode=false, curPts=[], curPath=null, rect=null;
function enableDrawMode(on){
  drawMode=on; document.getElementById('tabDraw').classList.toggle('active',on);
  alert(on?'–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ: –≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º –∫–æ–Ω—Ç—É—Ä –±—É–¥—É—â–µ–π –∑–æ–Ω—ã.':'–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ.');
}
function bindDrawing(){
  const wrap=document.getElementById('svgWrap');
  wrap.addEventListener('pointerdown',(e)=>{
    if(!drawMode) return;
    e.preventDefault();
    rect=wrap.getBoundingClientRect(); curPts=[]; const {x,y}=rel(e);
    curPts.push(x,y);
    if(curPath){ curPath.remove(); curPath=null; }
    const dl=document.createElementNS('http://www.w3.org/2000/svg','polyline');
    dl.setAttribute('points',''); dl.setAttribute('stroke','#333'); dl.setAttribute('stroke-width','2'); dl.setAttribute('fill','none'); dl.style.pointerEvents='none';
    document.getElementById('planSVG').appendChild(dl);
    curPath=dl; wrap.setPointerCapture(e.pointerId);
  });
  wrap.addEventListener('pointermove',(e)=>{
    if(!drawMode || !curPath) return;
    const {x,y}=rel(e); curPts.push(x,y);
    curPath.setAttribute('points', toSvgPoints(curPts));
  });
  wrap.addEventListener('pointerup', ()=>{
    if(!drawMode || !curPath) return;
    const pts = toPairs(curPts).map(([px,py])=>({ x:px*100, y:py*100 }));
    curPath.remove(); curPath=null;
    if(pts.length<3){ enableDrawMode(false); return; }
    askZoneMeta(pts);
  });
  function rel(e){ const cx=e.clientX, cy=e.clientY; return { x:(cx-rect.left)/rect.width, y:(cy-rect.top)/rect.height }; }
  function toSvgPoints(arr){ const out=[]; for(let i=0;i<arr.length;i+=2) out.push((arr[i]*1000)+','+(arr[i+1]*700)); return out.join(' '); }
  function toPairs(arr){ const r=[]; for(let i=0;i<arr.length;i+=2) r.push([arr[i],arr[i+1]]); return r; }
}
function askZoneMeta(points){
  const h=modal();
  h.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">–ù–æ–≤–∞—è –∑–æ–Ω–∞ –ø–æ —Å—Ö–µ–º–µ</div>
    <div class="row" style="gap:6px">
      <div><div class="muted mini">–ù–∞–∑–≤–∞–Ω–∏–µ</div><input id="zn" class="ctrl" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–æ–ª—ã 1‚Äì3"/></div>
      <div><div class="muted mini">–¶–≤–µ—Ç</div><input id="zc" type="color" class="ctrl" value="#ffd84d"/></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px;gap:6px">
      <button class="ctrl primary mini" id="ok">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="ctrl mini" id="cl">–û—Ç–º–µ–Ω–∞</button>
    </div>`;
  h.body.querySelector('#ok').onclick=()=>{
    const name=h.body.querySelector('#zn').value.trim(); const col=h.body.querySelector('#zc').value;
    if(!name) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
    db.svg.polys.push({ label:name, color:col, points });
    if(!db.halls['–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'].includes(name)) db.halls['–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'].push(name);
    save(); drawSVGPolys(); renderZones(); h.close(); enableDrawMode(false);
  };
  h.body.querySelector('#cl').onclick=()=>{ h.close(); enableDrawMode(false); };
}

/* ===== –ë–∞–Ω–∫–µ—Ç ===== */
function renderBanquets(){
  const p=$('#banquetPanel'); p.innerHTML='';
  dayData().banquets.forEach(b=>{
    const chip=renderBanquetChip(b,false, ()=>{ const d=dayData(); Object.values(d.assign).forEach(zmap=>{ Object.keys(zmap).forEach(z=>{ zmap[z]=(zmap[z]||[]).filter(e=>!(e.t==='b'&&e.id===b.id)); }); }); d.banquets=d.banquets.filter(x=>x.id!==b.id); save(); renderBanquets(); renderZones(); }, ()=> editBanquetModal(b) );
    p.appendChild(chip);
  });
}
function addBanquetModal(){ openBanquetModal(); }
function editBanquetModal(b){ openBanquetModal(b); }
function openBanquetModal(existing=null){
  const host=modal(); const halls=Object.keys(db.halls); const hallOpts=halls.map(h=>`<option>${h}</option>`).join('');
  const b = existing || {type:'–î–†', people:10, note:'', place:{hall:halls[0], zone:(db.halls[halls[0]]||[])[0]}};
  host.body.innerHTML=`
    <div class="row" style="flex-wrap:wrap;gap:8px">
      <div><div class="muted mini">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div><select id="bType" class="ctrl">${BANQUET_TYPES.map(t=>`<option ${t===b.type?'selected':''}>${t}</option>`).join('')}</select></div>
      <div><div class="muted mini">–ö–æ–ª-–≤–æ</div><input id="bPeople" class="ctrl" type="number" min="1" inputmode="numeric" value="${b.people||''}" placeholder="25"/></div>
      <div><div class="muted mini">–ó–∞–ª</div><select id="bHall" class="ctrl">${hallOpts}</select></div>
      <div><div class="muted mini">–ó–æ–Ω–∞</div><select id="bZone" class="ctrl"></select></div>
      <div style="flex:1 1 100%"><div class="muted mini">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><input id="bNote" class="ctrl" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è, —Ç–∞–π–º–∏–Ω–≥..." value="${(b.note||'').replace(/"/g,'&quot;')}"/></div>
      <div class="row" style="gap:8px;margin-top:4px"><button id="bOk" class="ctrl primary">${existing?'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å'}</button><button id="bCancel" class="ctrl">–û—Ç–º–µ–Ω–∞</button></div>
    </div>`;
  const hallSel=host.body.querySelector('#bHall'), zoneSel=host.body.querySelector('#bZone');
  hallSel.value=b.place?.hall||halls[0];
  function fill(){ zoneSel.innerHTML=''; (db.halls[hallSel.value]||[]).forEach(z=>{ const o=document.createElement('option'); o.textContent=z; zoneSel.appendChild(o); }); zoneSel.value = (b.place?.zone && db.halls[hallSel.value]?.includes(b.place.zone)) ? b.place.zone : (db.halls[hallSel.value]||[])[0]; }
  hallSel.onchange=fill; fill();
  host.body.querySelector('#bOk').onclick=()=>{
    const t=host.body.querySelector('#bType').value;
    const p=parseInt(host.body.querySelector('#bPeople').value||'0',10);
    const note=host.body.querySelector('#bNote').value.trim();
    const hall=hallSel.value, zone=zoneSel.value;
    if(!(p>0)) return alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫');
    const d=dayData();
    if(existing){
      existing.type=t; existing.people=p; existing.note=note; existing.place={hall,zone};
      Object.values(d.assign).forEach(zmap=>{ Object.keys(zmap).forEach(z=>{ zmap[z]=(zmap[z]||[]).filter(e=>!(e.t==='b'&&e.id===existing.id)); }); });
      d.assign[hall] ||= {}; d.assign[hall][zone] ||= []; d.assign[hall][zone].push({t:'b', id:existing.id});
    }else{
      const id='b'+Math.random().toString(36).slice(2);
      const rec={id,type:t,people:p,note,place:{hall,zone}};
      d.banquets.push(rec); d.assign[hall] ||= {}; d.assign[hall][zone] ||= []; d.assign[hall][zone].push({t:'b',id});
    }
    save(); renderBanquets(); renderZones(); host.close();
  };
  host.body.querySelector('#bCancel').onclick=host.close;
}

/* ===== –ó–∞–≤—Ç—Ä–∞–∫–∏: –ú–ï–°–Ø–ß–ù–´–ô –ì–†–ê–§–ò–ö ===== */
function openBreakfasts(){
  const host=modal();
  const now = new Date(curDay()+'T00:00');
  let y = now.getFullYear(), m = now.getMonth(); // —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
  host.body.innerHTML=`
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="muted mini">–ì—Ä–∞—Ñ–∏–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫–∏ (–∑–∞ –º–µ—Å—è—Ü)</div>
      <div class="row">
        <button class="ctrl mini" id="prevM">‚Üê</button>
        <div class="pill" id="monLbl"></div>
        <button class="ctrl mini" id="nextM">‚Üí</button>
      </div>
    </div>
    <div id="brList"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px;gap:6px">
      <button class="ctrl mini" id="sendMonth">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ—Å—è—Ü</button>
      <button class="ctrl mini" id="close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>`;
  host.body.querySelector('#close').onclick=host.close;
  host.body.querySelector('#prevM').onclick=()=>{ m--; if(m<0){m=11;y--;} renderMonth(); };
  host.body.querySelector('#nextM').onclick=()=>{ m++; if(m>11){m=0;y++;} renderMonth(); };
  host.body.querySelector('#sendMonth').onclick=()=>{ const msg=buildBreakfastMonth(y,m); const url='https://wa.me/?text='+encodeURIComponent(msg); window.open(url,'_blank'); };

  function renderMonth(){
    host.body.querySelector('#monLbl').textContent = new Date(y,m,1).toLocaleDateString('ru-RU',{year:'numeric',month:'long'});
    const list=host.body.querySelector('#brList'); list.innerHTML='';
    const last = new Date(y,m+1,0).getDate();
    for(let d=1; d<=last; d++){
      const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const names = db.breakfasts[iso]||[];
      const row=document.createElement('div'); row.className='box pad'; row.style.marginBottom='6px';
      row.innerHTML=`
        <div class="row" style="justify-content:space-between">
          <div><strong>${String(d).padStart(2,'0')}.${String(m+1).padStart(2,'0')}.${y}</strong> <span class="muted">(${weekday(iso)})</span></div>
          <div class="muted mini">${names.length? '–í—ã–±—Ä–∞–Ω—ã: '+names.join(', ') : '‚Äî'}</div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:6px">
          <button class="ctrl mini">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>`;
      const btn=row.querySelector('button'); btn.onclick=()=>editDay(iso, names);
      list.appendChild(row);
    }
  }
  function editDay(iso, current){
    const h=modal(); const all=[...db.waiters.shift1,...db.waiters.shift2]; const set=new Set(current||[]);
    h.body.innerHTML=`
      <div class="muted mini" style="margin-bottom:6px">–í—ã–±–æ—Ä –Ω–∞ ${fmtDate(iso)} (${weekday(iso)})</div>
      <div id="names"></div>
      <div class="row" style="justify-content:flex-end;margin-top:8px;gap:6px">
        <button class="ctrl primary mini" id="ok">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="ctrl mini" id="cl">–û—Ç–º–µ–Ω–∞</button>
      </div>`;
    const cont=h.body.querySelector('#names');
    all.forEach(n=>{
      const label=document.createElement('label'); label.style.display='inline-flex'; label.style.alignItems='center'; label.style.gap='6px'; label.style.margin='4px 8px 0 0';
      const box=document.createElement('input'); box.type='checkbox'; box.checked=set.has(n);
      box.onchange=()=>{ box.checked?set.add(n):set.delete(n); };
      label.appendChild(box); label.appendChild(document.createTextNode(n)); cont.appendChild(label);
    });
    h.body.querySelector('#ok').onclick=()=>{ db.breakfasts[iso]=Array.from(set); save(); renderMonth(); h.close(); };
    h.body.querySelector('#cl').onclick=()=>h.close();
  }
  function buildBreakfastMonth(Y,M){
    const last = new Date(Y,M+1,0).getDate();
    const lines=[`‚òï –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≤—Ç—Ä–∞–∫–æ–≤ –∑–∞ ${new Date(Y,M,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'})}:`];
    for(let d=1; d<=last; d++){
      const iso = `${Y}-${String(M+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const arr=db.breakfasts[iso]||[];
      if(!arr.length) continue;
      lines.push(`${fmtDate(iso)} (${weekday(iso)}): ${arr.join(', ')}`);
    }
    return lines.join('\n');
  }
  renderMonth();
}

/* ===== –≠–∫—Å–ø–æ—Ä—Ç / WhatsApp ===== */
function countUniqueAssigned(){ const d=dayData(); const used=new Set(); Object.values(d.assign).forEach(zmap=>{ Object.values(zmap).forEach(arr=>{ arr.filter(x=>x.t==='w').forEach(x=>used.add(x.name)); }); }); return used.size; }
function updateShiftBadge(){ $('#shiftBadge').textContent=`–í —Å–º–µ–Ω–∞ ${countUniqueAssigned()} —á–µ–ª–æ–≤–µ–∫`; }

function buildMessage(){
  const iso=curDay(), d=dayData(), lines=[];
  lines.push('–î–æ–±—Ä—ã–π –¥–µ–Ω—å, –¥—Ä—É–∑—å—è!');
  lines.push(`${fmtDate(iso)} (${weekday(iso)})`);
  lines.push(`–í —Å–º–µ–Ω–∞ ${countUniqueAssigned()} —á–µ–ª–æ–≤–µ–∫. üï∫`);
  if(d.banquets.length===0) lines.push('–ë–∞–Ω–∫–µ—Ç—ã: 0');
  else{ lines.push('–ë–∞–Ω–∫–µ—Ç—ã:'); d.banquets.forEach(b=>lines.push('‚Ä¢ '+banquetTitle(b))); }
  const br = db.breakfasts[iso]||[]; if(br.length){ lines.push(`‚òï –û—Ñ–∏—Ü–∏–∞–Ω—Ç –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫–∞—Ö ‚Äî ${br.join(', ')}.`); }
  Object.keys(d.assign).forEach(h=>{
    const zones=d.assign[h]; const non=Object.keys(zones).filter(z=>(zones[z]||[]).length>0);
    if(!non.length) return; lines.push(''); lines.push(`${(HALL_ICONS[h]||'üè†')} *${h}*`);
    non.forEach(z=>{
      const arr=zones[z];
      const text=arr.map(e=>{
        if(e.t==='w'){ const notes=(d.wNotes[e.name]||[]); return notes.length?`${e.name} (${notes.join('; ')})`:e.name; }
        const bb=d.banquets.find(x=>x.id===e.id); return bb?`${BANQUET_META[bb.type]?.ico||'üéà'} ${bb.type} ${bb.people}—á–µ–ª`:'–ë–∞–Ω–∫–µ—Ç';
      }).join(', ');
      const zico = ZONE_ICONS[z]||'‚Ä¢';
      lines.push(`${zico} ${z}: ${text}`);
    });
  });
  if(d.extraText){ lines.push(''); lines.push(d.extraText); }
  lines.push(''); lines.push('–í—Å–µ–º —Ö–æ—Ä–æ—à–µ–π —Å–º–µ–Ω—ã –∏ –±–æ–ª—å—à–∏—Ö —á–∞–µ–≤—ã—Ö! üíµ');
  return lines.join('\n');
}
function sendWhatsApp(){ const txt=buildMessage(); const app='whatsapp://send?text='+encodeURIComponent(txt); const web='https://wa.me/?text='+encodeURIComponent(txt); const a=document.createElement('a'); a.href=app; document.body.appendChild(a); a.click(); setTimeout(()=>{ window.open(web,'_blank'); a.remove(); },300); }

/* –°—Ö–µ–º–∞ ‚Üí PNG ‚Üí —Å–∏—Å—Ç–µ–º–Ω—ã–π Share (WhatsApp) */
async function sendPlanAsImage(){
  try{
    const svgEl = document.getElementById('planSVG');
    if(!svgEl){ alert('–û—Ç–∫—Ä–æ–π –≤–∫–ª–∞–¥–∫—É ¬´–°—Ö–µ–º–∞¬ª.'); return; }
    const s = new XMLSerializer().serializeToString(svgEl);
    const blobSvg = new Blob([s], {type:'image/svg+xml'});
    const url = URL.createObjectURL(blobSvg);
    const img = new Image();
    await new Promise(res=>{ img.onload=res; img.src=url; });
    const W = svgEl.viewBox.baseVal.width || 1000, H = svgEl.viewBox.baseVal.height||700;
    const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H);
    ctx.drawImage(img,0,0,W,H);
    URL.revokeObjectURL(url);
    const pngBlob = await new Promise(r=>canvas.toBlob(r,'image/png',0.92));
    const file = new File([pngBlob], `schema-${fmtDate(curDay())}.png`, {type:'image/png'});
    if(navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({ files:[file], text:`–°—Ö–µ–º–∞ ${fmtDate(curDay())}` }); }
    else{ const u=URL.createObjectURL(pngBlob); window.open(u,'_blank'); setTimeout(()=>URL.revokeObjectURL(u),20000); }
  }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ö–µ–º—ã: '+e.message); }
}

/* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∏–º–ø–æ—Ä—Ç JSON */
function saveToFile(){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`rota-${curDay()}.json`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0); }
function importFromFile(file){ const r=new FileReader(); r.onload=()=>{ try{
  const obj=JSON.parse(r.result);
  if(obj&&obj.waiters&&obj.halls&&obj.data){ db=obj; purgeOld(); save(); renderAll(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø.'); return; }
  if(obj&&(obj.assign||obj.banquets||obj.extraText!==undefined||obj.wNotes)){ const k=curDay(); db.data[k]={assign:obj.assign||{},banquets:obj.banquets||[],extraText:obj.extraText||'',wNotes:obj.wNotes||{},ozCustom:null}; purgeOld(); save(); renderAll(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è.'); return; }
  alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON.');
}catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e.message); } }; r.readAsText(file); }

/* ===== –†–µ–Ω–¥–µ—Ä –≤—Å–µ–≥–æ ===== */
function renderBanquetsAndWaiters(){ renderBanquets(); renderWaiters(); }
function renderAll(){ renderTop(); renderHalls(); renderZones(); renderBanquetsAndWaiters(); updateShiftBadge(); drawSVGPolys(); attachSVGHandlers(); }

/* ===== –°—Ç–∞—Ä—Ç ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const dEl=$('#date'); dEl.value=dEl.value||todayISO(); dEl.onchange=()=>{ renderAll(); save(); };
  renderAll();

  $('#toggleShift2').onclick=()=>{ const w=$('#wRow2Wrap'); w.style.display=(w.style.display==='none')?'block':'none'; };
  $('#addWaiterBtn').onclick=()=>{
    const host=modal();
    host.body.innerHTML=`<div class="row" style="gap:6px;align-items:flex-end"><div style="flex:1"><div class="muted mini">–ò–º—è</div><input id="nm" class="ctrl" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∞–≤–µ–ª"/></div><div><div class="muted mini">–°–º–µ–Ω–∞</div><select id="sh" class="ctrl"><option value="1">1-—è</option><option value="2">2-—è</option></select></div><button id="go" class="ctrl primary">–î–æ–±–∞–≤–∏—Ç—å</button><button id="cl" class="ctrl">–û—Ç–º–µ–Ω–∞</button></div>`;
    host.body.querySelector('#go').onclick=()=>{ const nm=(host.body.querySelector('#nm').value||'').trim(); const sh=host.body.querySelector('#sh').value; if(!nm) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); if(db.waiters.shift1.includes(nm)||db.waiters.shift2.includes(nm)) return alert('–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å'); if(sh==='1') db.waiters.shift1.push(nm); else db.waiters.shift2.push(nm); save(); renderWaiters(); host.close(); };
    host.body.querySelector('#cl').onclick=host.close;
  };

  $('#addBanquetBtn').onclick=addBanquetModal;
  $('#sendBtn').onclick=sendWhatsApp;
  $('#sendPlanBtn').onclick=()=>{ // –ø–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É ¬´–°—Ö–µ–º–∞¬ª –∏ –æ—Ç–ø—Ä–∞–≤–∏–º —Ñ–∞–π–ª
    document.getElementById('tabMap').click();
    setTimeout(sendPlanAsImage,150);
  };
  $('#breakfastBtn').onclick=openBreakfasts;
  $('#saveBtn').onclick=saveToFile;
  $('#importBtn').onclick=()=>document.getElementById('importFile').click();
  document.getElementById('importFile').onchange=(e)=>{ const f=e.target.files?.[0]; if(f) importFromFile(f); e.target.value=''; };

  // –¢–∞–±—ã ¬´–°–ø–∏—Å–æ–∫/–°—Ö–µ–º–∞/–†–∏—Å–æ–≤–∞—Ç—å¬ª
  $('#tabList').onclick=()=>{ $('#tabList').classList.add('active'); $('#tabMap').classList.remove('active'); $('#tabDraw').classList.remove('active'); $('#zonesBox').style.display='block'; $('#mapBox').style.display='none'; enableDrawMode(false); };
  $('#tabMap').onclick=()=>{ $('#tabMap').classList.add('active'); $('#tabList').classList.remove('active'); $('#tabDraw').classList.remove('active'); $('#zonesBox').style.display='none'; $('#mapBox').style.display='block'; enableDrawMode(false); };
  $('#tabDraw').onclick=()=>{ $('#tabMap').classList.add('active'); $('#tabList').classList.remove('active'); $('#mapBox').style.display='block'; $('#zonesBox').style.display='none'; enableDrawMode(true); };

  // –ü—Ä–∏–≤—è–∑–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
  bindDrawing();

  // SW
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
});
})();
</script>
</body>
</html>
