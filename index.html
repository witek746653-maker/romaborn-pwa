<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>Распределение — мобильный лэйаут</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffe9c4">

<style>
  :root{
    --ink:#2c2a29;--bg:#ffffff;--panel:#fffdfc;--line:#8b5e57;--muted:#7a6662;
    --accent:#f5e6da;--active:#ffe9c4;--badge:#ffd84d;--chip:#ffffff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.28 system-ui,-apple-system,Segoe UI,Roboto;height:100vh;overflow:hidden}
  button,input,select{font:inherit;color:inherit}
  .box{border:2px solid var(--line);border-radius:6px;background:var(--panel)}
  .pad{padding:8px}
  .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}

  .ctrl{border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:6px 8px;cursor:pointer}
  .ctrl.mini{padding:4px 6px;font-size:12px}
  .badge{border:2px solid var(--line);background:var(--badge);color:#1f1a0f;border-radius:20px;padding:4px 10px;font-weight:700;font-size:12px}

  /* ===== ДЕСКТОП (как раньше) ===== */
  .wrap{max-width:980px;margin:0 auto;padding:8px}
  .main{display:grid;grid-template-columns:1fr 1.2fr;gap:10px}
  .left{display:grid;gap:10px}
  .topbar .controls{display:flex;gap:6px;flex-wrap:wrap;align-items:center}

  /* ===== МОБИЛЬНЫЙ НОВЫЙ ЛЭЙАУТ ===== */
  @media (max-width:760px){
    .wrap{height:100vh;display:grid;grid-template-rows:15% 5% 20% 5% auto;gap:6px;padding:6px}
    .topbar{grid-row:1;min-height:0;overflow:auto}
    .hallsSec{grid-row:2;min-height:0;overflow:auto}
    .waitersSec{grid-row:3;min-height:0;overflow:auto}
    .zonesSec{grid-row:4;min-height:0;overflow:auto}
    .planSec{grid-row:5;min-height:0;overflow:hidden;display:flex;flex-direction:column}
    .topbar .controls{gap:4px}
    .topbar .ctrl, .topbar .badge {transform:scale(.92); transform-origin:left center}
  }

  /* шапка */
  .wday{min-width:136px}
  .controls .grow{flex:1 1 auto}

  /* «залы» строка (без заголовка) */
  .halls{display:flex;gap:6px;overflow:auto}
  .hall-btn{border:2px solid var(--line);background:var(--chip);border-radius:6px;padding:6px 8px;white-space:nowrap}
  .hall-btn.active{background:var(--active)}

  /* официанты */
  .w-row{display:flex;flex-wrap:wrap;gap:6px}
  .wchip{border:2px solid var(--line);background:var(--chip);border-radius:8px;min-width:88px;max-width:180px;padding:4px;display:flex;flex-direction:column;gap:2px}
  .wchip .top{display:flex;gap:6px;align-items:center}
  .w-dot{width:10px;height:10px;border-radius:50%}
  .w-name{font-weight:600;flex:1;min-width:0}
  .w-note{font-size:11px;color:var(--muted);white-space:normal}
  .iconbtn{border:1px solid var(--line);background:var(--chip);border-radius:4px;padding:0 6px;line-height:18px;height:18px;cursor:pointer}

  /* панель «Зоны» */
  .zonesHead{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .zonesBox{border:2px solid var(--line);border-radius:6px;background:var(--chip);padding:6px}
  .zone{border:2px dashed var(--line);border-radius:6px;padding:6px;margin-top:6px}
  .assign{border:2px solid var(--line);border-radius:8px;padding:4px 6px;display:inline-flex;flex-direction:column;gap:2px;min-width:100px;background:var(--chip)}
  .assign .row1{display:flex;gap:6px;align-items:center}
  .assign .x{border:none;background:none;font-weight:900;font-size:16px;line-height:1;cursor:pointer}
  .assign .small{font-size:11px;color:var(--muted)}

  /* СХЕМА — полотно */
  .svgWrap{position:relative;height:100%;border:2px dashed var(--line);border-radius:6px;overflow:hidden;background:#fff}
  .planSVG{position:absolute;inset:0;width:100%;height:100%}
  .zone-shape{cursor:pointer;transition:filter .15s,stroke-width .15s}
  .zone-shape:hover{filter:brightness(1.06);stroke-width:3}
  .soft{opacity:.45}

  /* модалка */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:10px;z-index:50}
  .dialog{background:var(--chip);border:2px solid var(--line);border-radius:8px;max-width:95vw;max-height:95vh;overflow:auto}
  .dialog .pad{padding:10px}

  /* банкет-плашки (компакт) */
  .banquets{display:flex;gap:6px;flex-wrap:wrap}
  .b-chip{border:2px solid var(--line);border-radius:10px;padding:4px 6px;display:inline-flex;align-items:flex-start;gap:6px;background:var(--chip)}
  .b-ico{font-size:15px}
  .b-body{display:flex;flex-direction:column;gap:1px}
  .b-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:210px}
  .b-note{font-size:11px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">

  <!-- ШАПКА (15%) -->
  <div class="topbar box pad">
    <div class="controls">
      <div class="ctrl mini"><div class="muted" style="font-size:11px">Дата</div><input id="date" type="date"/></div>
      <div id="wday" class="ctrl mini wday">—</div>
      <div id="shiftBadge" class="badge">В смена 0 человек</div>
      <button class="ctrl mini" id="sendBtn">Отправить</button>
      <button class="ctrl mini" id="sendPlanBtn">Отправить схему</button>
      <button class="ctrl mini" id="breakfastBtn">График завтраков</button>
      <div class="grow"></div>
      <button class="ctrl mini" id="addWaiterBtn">Добавить официанта</button>
      <button class="ctrl mini" id="saveBtn">Сохранить</button>
      <button class="ctrl mini" id="importBtn">Импорт</button>
      <input id="importFile" type="file" accept="application/json" hidden/>
    </div>

    <div class="row" style="margin-top:6px">
      <div class="banquets" id="banquetPanel"></div>
      <button class="ctrl mini" id="addBanquetBtn">Добавить банкет</button>
    </div>
  </div>

  <!-- ЗАЛЫ (5%) — без слова «Залы» -->
  <div class="hallsSec box pad">
    <div class="halls" id="hallBar"></div>
  </div>

  <!-- ОФИЦИАНТЫ (20%) -->
  <div class="waitersSec box pad">
    <div class="w-row" id="wRow1"></div>
    <button id="toggleShift2" class="ctrl mini">Смена 2</button>
    <div id="wRow2Wrap" style="display:none;margin-top:4px">
      <div class="w-row" id="wRow2"></div>
    </div>
  </div>

  <!-- ЗОНЫ (5%) -->
  <div class="zonesSec box pad">
    <div class="zonesHead">
      <div class="ctrl mini" id="tabList">Список</div>
      <div class="ctrl mini" id="tabDraw">Рисовать зону</div>
      <div class="ctrl mini" id="tabMap">Схема</div>
      <div class="ctrl mini" id="clearSelBtn">Очистить выбор</div>
      <div class="ctrl mini" id="sendPngBtn">Отправить схему</div>
      <div class="ctrl mini" id="zoneTitle">—</div>
    </div>
  </div>

  <!-- ПОЛОТНО СХЕМЫ (всё оставшееся место) -->
  <div class="planSec box pad">
    <!-- Список зон (по желанию открыть) -->
    <div id="zonesBox" class="zonesBox" style="display:none"></div>

    <!-- SVG-схема -->
    <div class="svgWrap" id="svgWrap">
      <svg id="planSVG" class="planSVG" viewBox="0 0 1113 768" aria-label="Схема зала">
        <!-- фон-картинка (та, что ты прислал) -->
        <image href="oz-scheme.png" x="0" y="0" width="1113" height="768" opacity="0.28"/>
        <g id="polysLayer"></g>
      </svg>
    </div>
  </div>

</div>

<!-- Модалка -->
<template id="modalTpl">
  <div class="modal"><div class="dialog"><div class="pad" id="modalBody"></div></div></div>
</template>

<script>
(() => {
'use strict';
/* ==== Утилиты/константы ==== */
const $=s=>document.querySelector(s), modalTpl=$('#modalTpl');
const STORAGE='rota-mobile-v8';
const DEFAULT_HALLS={
  'Основной зал':['Весь зал','Зона окна','5-я линия','Столы 7,8,9','Столы 10,11,12','Подиум'],
  'Малый (банкетный) зал':['МБЗ'],
  'ВИП-комнаты':['Все ВИПы','Большой ВИП','Малый ВИП','Каюта','Лиенда'],
  'Лофт':['Лофт'],
  'Веранда':['Веранда 1','Веранда 2'],
  'Винная комната':['Винная комната']
};
const SH1=['Элона','Полина','Настя','Виктор','Натали Ч.','Рома','Ксюша'];
const SH2=['Юля','Игорь','Катя','Наташа В.','Наташа Вел.','Артем','Маша','Инна','Лёша'];
const BANQUET_TYPES=['ДР','Юбилей','День памяти','Корпоратив','Конференция','Свадьба'];
const NOTE_PRESETS=['Помощь в ОЗ','Помощь на ВИПах','Помощь в МБЗ','Помощь на Веранде 1','Помощь на Веранде 2','Доставка','1-ый номер','2-ой номер'];

function defaultDB(){ return {waiters:{shift1:[...SH1],shift2:[...SH2]}, halls:JSON.parse(JSON.stringify(DEFAULT_HALLS)), data:{}, breakfasts:{}, svg:{polys:[]}}; }
let db=load()||defaultDB();
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE));}catch{return null} }
function save(){ localStorage.setItem(STORAGE, JSON.stringify(db)); }
function modal(){ const host=modalTpl.content.firstElementChild.cloneNode(true); const body=host.querySelector('#modalBody'); function close(){ host.remove(); } host.addEventListener('click',e=>{ if(e.target===host) close(); }); document.body.appendChild(host); return {el:host,body,close}; }
function todayISO(){ const z=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-z).toISOString().slice(0,10); }
function fmtDate(iso){ const [y,m,d]=iso.split('-'); return `${d}.${m}.${y}`; }
function weekday(iso){ const d=new Date(iso+'T00:00'); return ['вс','пн','вт','ср','чт','пт','сб'][d.getDay()]; } // для WA
function colorFor(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; const hue=h%360, sat=65, light=70; const fg=(light>60)?'#1f2937':'#fff'; return {bg:`hsl(${hue} ${sat}% ${light}%)`, fg}; }

/* ==== День ==== */
function curDay(){ return $('#date').value||todayISO(); }
function dayData(){ const k=curDay(); db.data[k] ||= {assign:{},banquets:[],wNotes:{},extraText:''}; return db.data[k]; }
function ensureHallZone(h,z){ const d=dayData(); d.assign[h] ||= {}; d.assign[h][z] ||= []; return d.assign[h][z]; }

/* ==== Верх и залы ==== */
let currentHall='Основной зал';
function renderTop(){ const iso=curDay(); $('#wday').textContent=fmtDate(iso); $('#zoneTitle').textContent=currentHall; }
function renderHalls(){ const bar=$('#hallBar'); bar.innerHTML=''; Object.keys(db.halls).forEach(h=>{ const b=document.createElement('button'); b.className='hall-btn'; b.textContent=h; if(h===currentHall) b.classList.add('active'); b.onclick=()=>{ currentHall=h; renderTop(); renderZones(); }; bar.appendChild(b); }); }

/* ==== Официанты ==== */
let selected=null;
function renderWaiters(){
  const r1=$('#wRow1'), r2=$('#wRow2'); r1.innerHTML=''; r2.innerHTML='';
  db.waiters.shift1.forEach(n=>r1.appendChild(chip(n)));
  db.waiters.shift2.forEach(n=>r2.appendChild(chip(n)));
  function chip(name){
    const notes=dayData().wNotes[name]||[];
    const {bg,fg}=colorFor(name);
    const wrap=document.createElement('div'); wrap.className='wchip';
    const top=document.createElement('div'); top.className='top';
    const dot=document.createElement('div'); dot.className='w-dot'; dot.style.background=bg;
    const nm=document.createElement('div'); nm.className='w-name'; nm.textContent=name; nm.style.color=fg;
    const edit=document.createElement('button'); edit.className='iconbtn'; edit.textContent='✎';
    const del=document.createElement('button'); del.className='iconbtn'; del.textContent='×';
    top.append(dot,nm,edit,del);
    const sub=document.createElement('div'); sub.className='w-note'; sub.textContent=notes.join('; ');
    wrap.append(top,sub);
    wrap.onclick=(e)=>{ if(e.target===edit||e.target===del) return; selected=(selected&&selected.kind==='w'&&selected.name===name)?null:{kind:'w',name}; };
    edit.onclick=(e)=>{ e.stopPropagation(); editNote(name); };
    del.onclick=(e)=>{ e.stopPropagation(); if(!confirm('Удалить имя?'))return; db.waiters.shift1=db.waiters.shift1.filter(x=>x!==name); db.waiters.shift2=db.waiters.shift2.filter(x=>x!==name); Object.values(dayData().assign).forEach(m=>Object.keys(m).forEach(z=>m[z]=m[z].filter(e=>!(e.t==='w'&&e.name===name)))); save(); renderWaiters(); renderZones(); updateShiftBadge(); };
    return wrap;
  }
}
function editNote(name){
  const host=modal(); const d=dayData(); const cur=new Set(d.wNotes[name]||[]);
  host.body.innerHTML=`<div style="font-size:12px" class="muted">Комментарии для <b>${name}</b></div><div id="list" style="margin:6px 0"></div><div class="row" style="justify-content:flex-end"><button class="ctrl mini" id="ok">OK</button><button class="ctrl mini" id="cl">Отмена</button></div>`;
  const list=host.body.querySelector('#list');
  NOTE_PRESETS.forEach(t=>{ const l=document.createElement('label'); l.style.marginRight='6px'; const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=cur.has(t); cb.onchange=()=>cb.checked?cur.add(t):cur.delete(t); l.append(cb,document.createTextNode(' '+t)); list.appendChild(l); });
  host.body.querySelector('#ok').onclick=()=>{ d.wNotes[name]=Array.from(cur); save(); renderWaiters(); renderZones(); host.close(); };
  host.body.querySelector('#cl').onclick=host.close;
}

/* ==== Зоны: список (минимум) ==== */
function renderZones(){
  $('#zoneTitle').textContent=currentHall;
  const box=$('#zonesBox'); box.innerHTML='';
  (db.halls[currentHall]||[]).forEach(z=>{
    const cont=document.createElement('div'); cont.className='zone';
    cont.innerHTML=`<b>${z}</b>`;
    const slot=document.createElement('div'); slot.className='slot'; cont.appendChild(slot);
    const arr=ensureHallZone(currentHall,z);
    const d=dayData();
    arr.forEach((e,i)=>{
      if(e.t==='w'){
        const a=document.createElement('div'); a.className='assign';
        const {bg,fg}=colorFor(e.name); a.style.background=bg; a.style.color=fg;
        a.innerHTML=`<div class="row1"><span>${e.name}</span><button class="x">×</button></div><div class="small">${(d.wNotes[e.name]||[]).join('; ')}</div>`;
        a.querySelector('.x').onclick=()=>{ arr.splice(i,1); save(); renderZones(); updateShiftBadge(); };
        slot.appendChild(a);
      }else{
        const b=d.banquets.find(x=>x.id===e.id); if(!b) return;
        const chip=document.createElement('div'); chip.className='assign'; chip.innerHTML=`<div class="row1"><span>🎉 ${b.type} • ${b.people}</span><button class="x">×</button></div><div class="small">${b.place?.hall||''} ${b.place?.zone||''} ${b.note||''}</div>`;
        chip.querySelector('.x').onclick=()=>{ arr.splice(i,1); save(); renderZones(); };
        slot.appendChild(chip);
      }
    });
    cont.onclick=()=>{ if(!selected) return; if(selected.kind==='w'){ if(!arr.some(x=>x.t==='w'&&x.name===selected.name)) arr.push({t:'w',name:selected.name}); } save(); renderZones(); updateShiftBadge(); };
    box.appendChild(cont);
  });
}

/* ==== СХЕМА: рисование произвольной зоны и назначение ==== */
function drawSVGPolys(){
  const layer=$('#polysLayer'); layer.innerHTML='';
  (db.svg.polys||[]).forEach((p,idx)=>{
    const poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', p.points.map(q=>`${q.x/100*1113},${q.y/100*768}`).join(' '));
    poly.setAttribute('data-idx', idx);
    poly.setAttribute('data-label', p.label);
    poly.setAttribute('fill', p.color ? toRGBA(p.color,.45) : 'rgba(255,216,77,.45)');
    poly.setAttribute('stroke','#00000055'); poly.setAttribute('stroke-width','2'); poly.classList.add('zone-shape','soft');
    $('#polysLayer').appendChild(poly);
  });
}
function toRGBA(hex,a){const v=hex.replace('#','');const r=parseInt(v.slice(0,2),16),g=parseInt(v.slice(2,4),16),b=parseInt(v.slice(4,6),16);return `rgba(${r},${g},${b},${a})`;}

/* клик по зоне = назначение */
$('#polysLayer').addEventListener('click',(e)=>{
  const poly=e.target.closest('.zone-shape'); if(!poly||!selected) return;
  const label=poly.getAttribute('data-label'); const arr=ensureHallZone('Основной зал',label);
  if(selected.kind==='w' && !arr.some(x=>x.t==='w'&&x.name===selected.name)){ arr.push({t:'w',name:selected.name}); }
  if(selected.kind==='b'){ const d=dayData(); if(!arr.some(x=>x.t==='b'&&x.id===selected.id)){ arr.push({t:'b',id:selected.id}); const bb=d.banquets.find(x=>x.id===selected.id); if(bb) bb.place={hall:'Основной зал',zone:label}; }
  }
  save(); renderZones(); updateShiftBadge();
});

/* долгое нажатие по зоне — редакт/удаление */
let hold=0;
$('#polysLayer').addEventListener('pointerdown',(e)=>{ const poly=e.target.closest('.zone-shape'); if(!poly) return; const idx=+poly.getAttribute('data-idx'); hold=setTimeout(()=>editPoly(idx),600); });
['pointerup','pointerleave'].forEach(ev=>$('#polysLayer').addEventListener(ev,()=>clearTimeout(hold)));

function editPoly(idx){
  const p=db.svg.polys[idx]; const h=modal();
  h.body.innerHTML=`<div class="row"><div><div class="muted" style="font-size:11px">Название</div><input id="zn" class="ctrl mini" value="${p.label.replace(/"/g,'&quot;')}"/></div><div><div class="muted" style="font-size:11px">Цвет</div><input id="zc" type="color" class="ctrl mini" value="${p.color||'#ffd84d'}"/></div><button id="ok" class="ctrl mini">Сохранить</button><button id="del" class="ctrl mini">Удалить</button></div>`;
  h.body.querySelector('#ok').onclick=()=>{ const name=h.body.querySelector('#zn').value.trim(); const col=h.body.querySelector('#zc').value; if(!name) return; if(name!==p.label){ const d=dayData(); d.assign['Основной зал'] ||= {}; d.assign['Основной зал'][name]=d.assign['Основной зал'][p.label]||[]; delete d.assign['Основной зал'][p.label]; const list=db.halls['Основной зал']; const i=list.indexOf(p.label); if(i>=0) list.splice(i,1,name); p.label=name; } p.color=col; save(); drawSVGPolys(); renderZones(); h.close(); };
  h.body.querySelector('#del').onclick=()=>{ if(!confirm('Удалить зону?'))return; delete (dayData().assign['Основной зал']||{})[p.label]; db.halls['Основной зал']=db.halls['Основной зал'].filter(x=>x!==p.label); db.svg.polys.splice(idx,1); save(); drawSVGPolys(); renderZones(); h.close(); };
}

/* Рисование зоны */
let drawMode=false, curPts=[], curPath=null, rect=null;
function enableDraw(on){ drawMode=on; alert(on?'Рисование включено: обведите пальцем зону.':'Рисование выключено.'); }
$('#tabDraw').onclick=()=>{ enableDraw(true); };
$('#tabList').onclick=()=>{ $('#zonesBox').style.display=$('#zonesBox').style.display==='none'?'block':'none'; };
$('#tabMap').onclick=()=>{ /* просто для вида */ };

const wrap=$('#svgWrap');
wrap.addEventListener('pointerdown',(e)=>{
  if(!drawMode) return;
  e.preventDefault(); rect=wrap.getBoundingClientRect(); curPts=[];
  const {x,y}=rel(e); curPts.push(x,y);
  if(curPath){ curPath.remove(); curPath=null; }
  curPath=document.createElementNS('http://www.w3.org/2000/svg','polyline');
  curPath.setAttribute('points',''); curPath.setAttribute('stroke','#333'); curPath.setAttribute('stroke-width','2'); curPath.setAttribute('fill','none'); curPath.style.pointerEvents='none';
  $('#planSVG').appendChild(curPath); wrap.setPointerCapture(e.pointerId);
});
wrap.addEventListener('pointermove',(e)=>{
  if(!drawMode||!curPath) return; const {x,y}=rel(e); curPts.push(x,y); curPath.setAttribute('points', curPtsToStr(curPts));
});
wrap.addEventListener('pointerup', ()=>{
  if(!drawMode||!curPath) return;
  const pts = toPairs(curPts).map(([px,py])=>({x:px*100,y:py*100}));
  curPath.remove(); curPath=null;
  if(pts.length<3){ enableDraw(false); return; }
  askZoneMeta(pts);
});
function rel(e){ const cx=e.clientX, cy=e.clientY; return {x:(cx-rect.left)/rect.width, y:(cy-rect.top)/rect.height}; }
function curPtsToStr(arr){ const out=[]; for(let i=0;i<arr.length;i+=2) out.push((arr[i]*1113)+','+(arr[i+1]*768)); return out.join(' '); }
function toPairs(arr){ const r=[]; for(let i=0;i<arr.length;i+=2) r.push([arr[i],arr[i+1]]); return r; }

function askZoneMeta(points){
  const h=modal();
  h.body.innerHTML=`<div class="row"><div><div class="muted" style="font-size:11px">Название</div><input id="zn" class="ctrl mini" placeholder="Например: Столы 1–3"/></div><div><div class="muted" style="font-size:11px">Цвет</div><input id="zc" type="color" class="ctrl mini" value="#ffd84d"/></div><button id="ok" class="ctrl mini">Создать</button><button id="cl" class="ctrl mini">Отмена</button></div>`;
  h.body.querySelector('#ok').onclick=()=>{ const name=h.body.querySelector('#zn').value.trim(); const col=h.body.querySelector('#zc').value; if(!name) return; db.svg.polys.push({label:name,color:col,points}); if(!db.halls['Основной зал'].includes(name)) db.halls['Основной зал'].push(name); save(); drawSVGPolys(); renderZones(); h.close(); enableDraw(false); };
  h.body.querySelector('#cl').onclick=()=>{ h.close(); enableDraw(false); };
}

/* Банкет */
function renderBanquets(){ const p=$('#banquetPanel'); p.innerHTML=''; dayData().banquets.forEach(b=>{ const chip=document.createElement('span'); chip.className='b-chip'; chip.innerHTML=`<span class="b-ico">🎉</span><span class="b-body"><span class="b-title">${b.type} • ${b.people} • ${(b.place?.zone||b.place?.hall||'—')}</span>${b.note?`<span class="b-note">${b.note}</span>`:''}</span>`; const x=document.createElement('button'); x.className='iconbtn'; x.textContent='×'; x.onclick=()=>{ const d=dayData(); Object.values(d.assign).forEach(zm=>Object.keys(zm).forEach(z=>zm[z]=zm[z].filter(e=>!(e.t==='b'&&e.id===b.id)))); d.banquets=d.banquets.filter(x=>x.id!==b.id); save(); renderBanquets(); renderZones(); }; chip.appendChild(x); p.appendChild(chip); }); }
$('#addBanquetBtn').onclick=()=>openBanquet();

function openBanquet(){
  const host=modal(); const halls=Object.keys(db.halls);
  host.body.innerHTML=`<div class="row"><div><div class="muted" style="font-size:11px">Тип</div><select id="t" class="ctrl mini">${BANQUET_TYPES.map(t=>`<option>${t}</option>`).join('')}</select></div><div><div class="muted" style="font-size:11px">Кол-во</div><input id="p" class="ctrl mini" type="number" min="1" inputmode="numeric"/></div><div><div class="muted" style="font-size:11px">Зал</div><select id="h" class="ctrl mini">${halls.map(h=>`<option>${h}</option>`)}</select></div><div><div class="muted" style="font-size:11px">Зона</div><select id="z" class="ctrl mini"></select></div><div style="flex:1"><div class="muted" style="font-size:11px">Комментарий</div><input id="n" class="ctrl mini"/></div><button id="ok" class="ctrl mini">Добавить</button><button id="cl" class="ctrl mini">Отмена</button></div>`;
  const h=host.body.querySelector('#h'), z=host.body.querySelector('#z'); const fill=()=>{ z.innerHTML=''; (db.halls[h.value]||[]).forEach(x=>{ const o=document.createElement('option'); o.textContent=x; z.appendChild(o); }); }; h.onchange=fill; fill();
  host.body.querySelector('#ok').onclick=()=>{ const type=host.body.querySelector('#t').value; const people=parseInt(host.body.querySelector('#p').value||'0',10); const note=host.body.querySelector('#n').value.trim(); if(!(people>0)) return; const id='b'+Math.random().toString(36).slice(2); const hall=h.value, zone=z.value; const d=dayData(); d.banquets.push({id,type,people,note,place:{hall,zone}}); d.assign[hall] ||= {}; d.assign[hall][zone] ||= []; d.assign[hall][zone].push({t:'b',id}); save(); renderBanquets(); renderZones(); host.close(); };
  host.body.querySelector('#cl').onclick=host.close;
}

/* Завтраки — КОМПАКТ (без дня недели), месяц в 2 колонки */
$('#breakfastBtn').onclick=()=>{
  const host=modal();
  const now=new Date(curDay()+'T00:00'); let y=now.getFullYear(), m=now.getMonth();
  host.body.innerHTML=`<div class="row" style="justify-content:space-between"><div class="ctrl mini" id="prev">←</div><div class="ctrl mini" id="lbl"></div><div class="ctrl mini" id="next">→</div></div><div id="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px"></div><div class="row" style="justify-content:flex-end;margin-top:6px"><button class="ctrl mini" id="send">Отправить месяц</button><button class="ctrl mini" id="close">Закрыть</button></div>`;
  const lbl=host.body.querySelector('#lbl'), grid=host.body.querySelector('#grid');
  const render=()=>{ lbl.textContent=new Date(y,m,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'}); grid.innerHTML=''; const last=new Date(y,m+1,0).getDate(); for(let d=1; d<=last; d++){ const iso=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const names=db.breakfasts[iso]||[]; const cell=document.createElement('div'); cell.className='box pad'; cell.style.fontSize='12px'; cell.innerHTML=`<div style="display:flex;justify-content:space-between"><b>${String(d).padStart(2,'0')}.${String(m+1).padStart(2,'0')}.${y}</b><span class="muted" style="font-size:11px">${names.join(', ')||'—'}</span></div><div class="row" style="justify-content:flex-end"><button class="ctrl mini">Изм.</button></div>`; cell.querySelector('button').onclick=()=>editDay(iso,names); grid.appendChild(cell);} };
  function editDay(iso,current){ const h=modal(); const all=[...db.waiters.shift1,...db.waiters.shift2]; const set=new Set(current||[]); h.body.innerHTML=`<div style="font-size:12px" class="muted">${fmtDate(iso)}</div><div id="n"></div><div class="row" style="justify-content:flex-end;margin-top:6px"><button class="ctrl mini" id="ok">OK</button><button class="ctrl mini" id="cl">Отмена</button></div>`; const n=h.body.querySelector('#n'); all.forEach(w=>{ const L=document.createElement('label'); L.style.marginRight='6px'; const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=set.has(w); cb.onchange=()=>cb.checked?set.add(w):set.delete(w); L.append(cb,document.createTextNode(' '+w)); n.appendChild(L); }); h.body.querySelector('#ok').onclick=()=>{ db.breakfasts[iso]=Array.from(set); save(); render(); h.close(); }; h.body.querySelector('#cl').onclick=()=>h.close(); }
  host.body.querySelector('#prev').onclick=()=>{ m--; if(m<0){m=11;y--;} render(); };
  host.body.querySelector('#next').onclick=()=>{ m++; if(m>11){m=0;y++;} render(); };
  host.body.querySelector('#send').onclick=()=>{ const last=new Date(y,m+1,0).getDate(); const lines=[`☕ График завтраков за ${new Date(y,m,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'})}:`]; for(let d=1; d<=last; d++){ const iso=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const arr=db.breakfasts[iso]||[]; if(!arr.length) continue; lines.push(`${fmtDate(iso)}: ${arr.join(', ')}`); } const url='https://wa.me/?text='+encodeURIComponent(lines.join('\n')); window.open(url,'_blank'); };
  host.body.querySelector('#close').onclick=host.close;
  render();
};

/* Счётчик людей */
function countUnique(){ const used=new Set(); const d=dayData(); Object.values(d.assign).forEach(zm=>Object.values(zm).forEach(arr=>arr.filter(x=>x.t==='w').forEach(x=>used.add(x.name)))); return used.size; }
function updateShiftBadge(){ $('#shiftBadge').textContent=`В смена ${countUnique()} человек`; }

/* WhatsApp текст */
function buildMessage(){
  const d=dayData(), iso=curDay(), lines=[];
  lines.push('Добрый день, друзья!');
  lines.push(`${fmtDate(iso)} (${weekday(iso)})`);
  lines.push(`В смена ${countUnique()} человек. 🕺`);
  lines.push('Банкеты:'+(d.banquets.length? '' : ' 0'));
  d.banquets.forEach(b=>lines.push(`• ${b.type} • ${b.people} • ${(b.place?.zone||b.place?.hall||'—')}${b.note?` • ${b.note}`:''}`));
  Object.keys(d.assign).forEach(h=>{
    const zm=d.assign[h]; const non=Object.keys(zm).filter(z=>zm[z]?.length); if(!non.length) return;
    lines.push(''); lines.push(h);
    non.forEach(z=>{ const txt=zm[z].map(e=> e.t==='w'?e.name:`🎉 ${d.banquets.find(x=>x.id===e.id)?.type||'Банкет'}`).join(', '); lines.push(`${z}: ${txt}`); });
  });
  lines.push(''); lines.push('Всем хорошей смены и больших чаевых! 💵');
  return lines.join('\n');
}
function sendWhatsApp(){ const txt=buildMessage(); const app='whatsapp://send?text='+encodeURIComponent(txt); const web='https://wa.me/?text='+encodeURIComponent(txt); const a=document.createElement('a'); a.href=app; document.body.appendChild(a); a.click(); setTimeout(()=>{ window.open(web,'_blank'); a.remove(); },300); }
$('#sendBtn').onclick=sendWhatsApp;

/* Схема → PNG → системный шаринг (WhatsApp) */
async function sendPlanAsImage(){
  try{
    const svgEl = document.getElementById('planSVG'); const s = new XMLSerializer().serializeToString(svgEl);
    const blobSvg = new Blob([s], {type:'image/svg+xml'}); const url = URL.createObjectURL(blobSvg);
    const img = new Image(); await new Promise(res=>{ img.onload=res; img.src=url; });
    const W=1113,H=768; const canvas=document.createElement('canvas'); canvas.width=W; canvas.height=H;
    const ctx=canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H); ctx.drawImage(img,0,0,W,H); URL.revokeObjectURL(url);
    const pngBlob = await new Promise(r=>canvas.toBlob(r,'image/png',0.92)); const file = new File([pngBlob], `schema-${fmtDate(curDay())}.png`, {type:'image/png'});
    if(navigator.canShare && navigator.canShare({files:[file]})) await navigator.share({files:[file],text:`Схема ${fmtDate(curDay())}`}); else { const u=URL.createObjectURL(pngBlob); window.open(u,'_blank'); setTimeout(()=>URL.revokeObjectURL(u),20000); }
  }catch(e){ alert('Не удалось сформировать изображение: '+e.message); }
}
$('#sendPlanBtn').onclick=sendPlanAsImage; $('#sendPngBtn').onclick=sendPlanAsImage;

/* Сохранить / Импорт */
function saveToFile(){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`rota-${curDay()}.json`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0); }
$('#saveBtn').onclick=saveToFile;
$('#importBtn').onclick=()=>$('#importFile').click();
$('#importFile').onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.waiters&&obj.halls&&obj.data){ db=obj; save(); renderAll(); alert('Импортирован полный бэкап.'); }else{ alert('Неверный формат.'); } }catch(err){ alert('Ошибка импорта: '+err.message); } }; r.readAsText(f); e.target.value=''; };

/* Инициализация */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#date').value=$('#date').value||todayISO();
  $('#date').onchange=()=>{ renderAll(); save(); };
  $('#toggleShift2').onclick=()=>{ const w=$('#wRow2Wrap'); w.style.display = w.style.display==='none' ? 'block' : 'none'; };
  renderAll();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
});
function renderAll(){ renderTop(); renderHalls(); renderWaiters(); renderZones(); drawSVGPolys(); updateShiftBadge(); }
})();
</script>
</body>
</html>
